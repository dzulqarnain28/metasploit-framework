#include <stdio.h>
#include <stdlib.h>
#include <stdlib.h>
#include <netdb.h>
#include <sys/wait.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <string.h>

#define PORT 12345

int alive = 1;

void overflow (char *src, size_t len)
{
	char dst[60];

	printf("DEBUG: payload length: %lu | %s.\n", len, src);

	memcpy(dst, src, len);
}

void worker_code (int sock)
{
	int ret;
	char src[BUFSIZ];

	do {
		ret = read(sock, src, BUFSIZ);
		if (ret < 1) {
			perror("read failed");
			break;
		}

		overflow(src, ret);

		write(sock, src, ret);
	}
	while (strncmp(src, "quit", 4));

	alive = 0;
	close(sock);
}

int main (int argc, char **argv)
{
	pid_t pid;
	unsigned int len;
	struct sockaddr_in sin, sout;
	int ret, sock, csock, port = PORT;

	if (argc > 1)
		port = atoi(argv[1]);
init:
	printf("using port: %d\n", port);

	memset(&sin, 0, sizeof(sin));
	sin.sin_family = AF_INET;
	sin.sin_port = htons(port);
	sin.sin_addr.s_addr = INADDR_ANY;

	sock = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);
	if (sock < 0) {
		perror("socket failed");
		return 0;
	}

	ret = bind(sock, (struct sockaddr *)&sin, sizeof(sin));
	if (ret < 0) {
		perror("bind failed");
		close(sock);
		port++;
		goto init;
	}

	ret = listen(sock, 5);
	if (ret < 0) {
		perror("listen failed");
		close(sock);
		return 0;
	}

	do {
		len = sizeof(sout);
		csock = accept(sock, (struct sockaddr *)&sout, &len);
		if (csock < 0) {
			perror("accept failed");
			close(sock);
			return 0;
		}

		pid = fork();
		if (!pid) {
			worker_code(csock);
			exit(0);
		}
		else wait(NULL);

		close(csock);
	}
	while (alive);

	close(csock);
	close(sock);
	return 0;
}

