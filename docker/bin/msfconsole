#! /bin/bash

if [[ -z "$MSF_PATH" ]]; then
  path=`dirname $0`

  # check for ./docker/msfconsole.rc
  if [[ ! -f $path/../msfconsole.rc ]]; then

    # we are not inside the project
    realpath --version > /dev/null 2>&1 || { echo >&2 "I couldn't find where metasploit is. Set \$MSF_PATH or execute this from the project root"; exit 1 ;}

    # determine script path
    pushd $(dirname $(realpath $0)) > /dev/null
    path=$(pwd)
    popd > /dev/null
  fi
  MSF_PATH=$(dirname $(dirname $path))
fi

cd $MSF_PATH

if [[ -n "$MSF_BUILD" ]]; then
  docker-compose -f $MSF_PATH/docker-compose.yml build
fi

if [[ ! -z "$DOT_MSF" ]]; then
  DOT_MSF="/tmp/.msf4"
fi

# check if .msf4 doesn't exist
if [[ -d "$DOT_MSF" ]]; then

  # check if root
  if [[ $EUID -eq 0 ]]; then

    # notify user about the folder creation
    read -p "Script is going to make $DOT_MSF directory for docker mount
Proceed? (Y/n)" -n 1 -r
    echo

    if [[ $REPLY =~ ^[Yy]$ ]]; then
      mkdir "$DOT_MSF" && chmod 777 "$DOT_MSF"
    else
      exit 1
    fi

  # if non-root user
  else
    mkdir "$DOT_MSF"
  fi
fi

docker-compose run --rm --service-ports ms ./msfconsole -r docker/msfconsole.rc "$@"
