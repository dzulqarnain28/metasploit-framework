## Vulnerable Application
Windows 10 v1803 to v2004 machines prior to the August 2020 Patch Tuesday updates are vulnerable to an local privilege elevation
vulnerability in Windows Setup due to a time-of-check-time-of-use (TOCTOU) issue when setting the directory permissions for the `C:\$WINDOWS.~BT`
directory. More specifically the code first called `CreateDirectoryW()` to create a directory before then setting the permissions
on that folder via a `SetSecurityInfo()` call. This allowed users to redirect the `SetSecurityInfo()` call by creating a directory junction 
at `C:\$WINDOWS.~BT`, or the directory which was created with open permissions (due to a `NULL` security descriptor being passed to the 
`CreateDirectoryW()` call), and thereby cause the `SetSecurityInfo()` call to be called on a different directory, which would then be granted 
different permissions, which could lead to a security flaw.

The issue with this, as discussed by @klinix5, who discovered the bug, is that whilst Microsoft correctly fixed this code so that only one
call is made to `CreateDirectoryW()` with the permissions that were previously set via the `SetSecurityInfo()` call, they didn't validate that
`C:\$WINDOWS.~BT` is actually a proper directory and not a directory junction prior to deleting it via a call to `DeleteFolderWithPath()` as part
of Windows Setup's cleanup code.

As a result an attacker can create the `C:\$WINDOWS.~BT` directory, set one of its subdirectories to be a directory junction pointing to a target
folder to be deleted, and the start the Windows Setup upgrade. This will cause Windows Setup to try and delete the `C:\$WINDOWS.~BT` directory 
as the `SYSTEM` user. However since `C:\$WINDOWS.~BT` is now a directory junction which points to an attacker specified directory, Windows Setup 
will instead delete that directory as the `SYSTEM` user, thereby granting the attacker arbitrary folder deletion as `SYSTEM`.

With the ability to delete arbitrary folders as the `SYSTEM` user, attackers can then proceed to use the direction deletion technique described in
@jonaslyk's Secret.Club post at https://secret.club/2020/04/23/directory-deletion-shell.html to elevate their privileges to `SYSTEM` via a DLL planting
attack. 

This module uses the patch bypass as well as a variation of @jonaslyk's technique, to gain a shell as `NT AUTHORITY\NETWORK SERVICE` on affected Windows 10
systems prior to version 2004. This patch bypass is unpatched as of August 25th 2020.

### Installation And Setup
All affected systems should have Windows Setup installed as it is a core component of Windows 10 operating systems and it cannot be removed.

## Verification Steps
  1. Start msfconsole
  2. Get a session as a low privileged user on a Windows 10 machine
  3. Do: On the target machine go to ```Settings``` and click ```Check for Updates```. 
  4. Confirm that you can see a section titled ```Feature Update``` with a link titled ```Download and Install``` underneath it.
  5. Do: ```use exploit/windows/local/cve_2020_1571_windows_setup_lpe```
  6. Do: ```set SESSION <sess_no>```
  7. Do: ```set WaitTime <minutes>``` to set the number of minutes you want to wait the exploit to wait for the DLL to complete its job before continuing.
  8. Do: ```set WritableDir <directory>``` if you want to alter the location of the writeable directory to place temporary files into.
  9. Do: Set the ```LPORT``` and ```RHOST``` options for the payload as needed.
  10. Do: ```run``` 
  8. Click the ```Download and Install``` button under the section titled ```Feature Update``` to start the system upgrade process.
  7. You should get a shell running as ```NT AUTHORITY\NETWORK SERVICE``` a few minutes after the timer specified in the ```WaitTime``` option expires.

## Options
  **WaitTime**
  Time to wait for the reflectively loaded DLL to exploit CVE-2020-1571 and complete its operations
  before the Metasploit code runs and tries to gain privileges via a DLL hijacking attack. Setting
  this timer to too low of a value will result in the exploit failing so its recommended to set 
  this slightly over your expected wait time to allow for a margin of error.
  
  **WritableDir**
  Location of a directory that the current user on the target system has write access to. Used to 
  store various temporary files as part of the exploitation process.

## Scenarios

### Windows 10 v1909 x64 - Build 18363.1016
```

```
